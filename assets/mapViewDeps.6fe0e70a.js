var Es=Object.defineProperty,Ts=Object.defineProperties;var xs=Object.getOwnPropertyDescriptors;var Ye=Object.getOwnPropertySymbols;var ws=Object.prototype.hasOwnProperty,ys=Object.prototype.propertyIsEnumerable;var je=(r,t,e)=>t in r?Es(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,j=(r,t)=>{for(var e in t||(t={}))ws.call(t,e)&&je(r,e,t[e]);if(Ye)for(var e of Ye(t))ys.call(t,e)&&je(r,e,t[e]);return r},At=(r,t)=>Ts(r,xs(t));import{c as ct,r as D,w as Fs,d as ge,C as ie,h as Rs,v as Bs,m as Xi,e as z,j as _t,p as As,s as re,l as Ss,k as Hi,q as Os,t as N,u as ft,x as yt,y as Cs,b as Ms,z as Ps,A as De,o as me,B as Ds,D as Ke,E as Is,$ as Us,F as pt,G as Ns,n as Ls,H as zs,I as $s,J as Gs,K as qi,L as Yi,M as ks,N as Vs,O as ae,P as Ws,Q as Xs,R as Hs,S as qs,T as et,U as Tt,V as Ys,W as js,X as Gt,Y as Ks,Z as P,_ as L,a0 as kt,a1 as Ze,a2 as Zs,a3 as ji,a4 as Qs,a5 as Js,a6 as Ki,a7 as Ee,a8 as Te,a9 as tr,aa as be,ab as er,ac as ir,ad as sr,ae as rr,af as nr,ag as Ie,ah as ar,ai as or,aj as Qe,ak as lr,al as hr,am as ur}from"./GISSearch.b73a2371.js";import{o as dr,n as cr,r as _r,s as fr}from"./CIMSymbolHelper.1040926f.js";import{s as Je,a as pr}from"./Container.e5cc492f.js";import{I as Q,E as mr,O as oe,N as gr,a as br,y as ti,g as vr,A as le,L as ei,T as Er,w as Tr,h as Zi,S as xr,b as he}from"./Utils.e0214b13.js";import{n as J,t as wr,a as Vt,w as Lt,m as Qi}from"./WGLContainer.ad96b13e.js";import{T as K}from"./enums.1ba846bb.js";import{e as yr,b as se}from"./ProgramTemplate.85782ebc.js";import{e as Rt,s as Fr}from"./programUtils.d4a989ec.js";import{f as Bt,c as gt,D as $,r as Rr,i as ii}from"./VertexArrayObject.4ccd043a.js";import{R,E as X,F as bt,P as y,G as O,L as S,D as U,M as I,C as Pt,Y as k,V,B as Br,T as Ue,N as Mt,S as Ji,I as zt,O as mt,f as Qt,U as Ar,_ as jt,A as F,X as we,n as rt,e as Sr,r as si,u as Or}from"./enums.457e23f9.js";import{m as Cr}from"./Rasterizer.8006df47.js";import{$ as Wt,y as ri,u as ni,K as Mr,A as Pr,B as Dr,G as ts,F as Xt,V as es,L as ai,R as Ir,S as Ur}from"./enums.84480fc7.js";import{n as Nr}from"./cimAnalyzer.74547477.js";import{t as it}from"./BidiEngine.b9926823.js";import{u as H,n as W,a as xt}from"./Texture.df7d53ef.js";import{P as oi}from"./GeometryUtils.5ea26345.js";import{e as ye}from"./Matcher.4b2c4793.js";import{t as $t}from"./VertexElementDescriptor.0406f2d4.js";import{s as Lr}from"./CircularArray.e6c8d66c.js";import{o as li,W as zr,A as $r,M as Gr,t as hi}from"./requestImageUtils.3147d41d.js";import{t as kr}from"./ComputedAttributeStorage.2a68a55c.js";import{r as ul}from"./BaseGraphicContainer.438c4e75.js";import{i as cl}from"./GraphicContainer.21c2e17d.js";import{_ as ui}from"./index.8ac88fb7.js";import"./ProjectWeberRenew.dc78a7b0.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./alignmentUtils.03ee467b.js";import"./number.dc47462b.js";import"./GeometryUtils.e53da643.js";import"./pixelUtils.9fff4c99.js";import"./StyleDefinition.809d5a5e.js";import"./config.bd364997.js";import"./MaterialKey.9859c524.js";import"./earcut.91e104de.js";import"./quantizationUtils.48cd94ed.js";import"./visualVariablesUtils.65d2f75d.js";import"./visualVariablesUtils.54823ca9.js";import"./tileUtils.fab497ef.js";import"./TileClipper.2c69e8d5.js";import"./Geometry.e891c191.js";import"./ExpandedCIM.d4661ffb.js";import"./projectionSupport.66acda0b.js";import"./json.da51edc4.js";import"./FeatureContainer.2f011771.js";import"./TileContainer.9dcdd226.js";import"./schemaUtils.d3838579.js";import"./createSymbolSchema.4fe41dfb.js";import"./MD5.67d7a872.js";import"./util.837deeb3.js";import"./vec3f32.8179e08f.js";const Vr={background:{"background.frag":`#ifdef PATTERN
uniform lowp float u_opacity;
uniform lowp sampler2D u_texture;
varying mediump vec4 v_tlbr;
varying mediump vec2 v_tileTextureCoord;
#else
uniform lowp vec4 u_color;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
void main() {
#ifdef PATTERN
mediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);
mediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);
lowp vec4 color = texture2D(u_texture, samplePos);
gl_FragColor = u_opacity * color;
#else
gl_FragColor = u_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"background.vert":`precision mediump float;
attribute vec2 a_pos;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform mediump float u_coord_range;
uniform mediump float u_depth;
#ifdef PATTERN
uniform mediump mat3 u_pattern_matrix;
varying mediump vec2 v_tileTextureCoord;
uniform mediump vec4 u_tlbr;
uniform mediump vec2 u_mosaicSize;
varying mediump vec4 v_tlbr;
#endif
void main() {
gl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);
#ifdef PATTERN
v_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;
v_tlbr             = u_tlbr / u_mosaicSize.xyxy;
#endif
#ifdef ID
v_id = u_id / 255.0;
#endif
}`},circle:{"circle.frag":`precision lowp float;
varying lowp vec4 v_color;
varying lowp vec4 v_stroke_color;
varying mediump float v_blur;
varying mediump float v_stroke_width;
varying mediump float v_radius;
varying mediump vec2 v_offset;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
mediump float dist = length(v_offset);
mediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);
lowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));
gl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"circle.vert":`precision mediump float;
attribute vec2 a_pos;
#pragma header
varying lowp vec4 v_color;
varying lowp vec4 v_stroke_color;
varying mediump float v_blur;
varying mediump float v_stroke_width;
varying mediump float v_radius;
varying mediump vec2 v_offset;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump vec2 u_circleTranslation;
uniform mediump float u_depth;
uniform mediump float u_antialiasingWidth;
void main()
{
#pragma main
v_color = color * opacity;
v_stroke_color = stroke_color * stroke_opacity;
v_stroke_width = stroke_width;
v_radius = radius;
v_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));
mediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);
v_offset = offset;
#ifdef ID
v_id = u_id / 255.0;
#endif
mediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},fill:{"fill.frag":`precision lowp float;
#ifdef PATTERN
uniform lowp sampler2D u_texture;
varying mediump vec2 v_tileTextureCoord;
varying mediump vec4 v_tlbr;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
vec4 mixColors(vec4 color1, vec4 color2) {
float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);
vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);
return vec4(compositeColor, compositeAlpha);
}
void main()
{
#ifdef PATTERN
mediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);
mediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);
lowp vec4 color = texture2D(u_texture, samplePos);
gl_FragColor = v_color[3] * color;
#else
gl_FragColor = v_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"fill.vert":`precision mediump float;
attribute vec2 a_pos;
#pragma header
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump float u_depth;
uniform mediump vec2 u_fillTranslation;
#ifdef PATTERN
#include <util/util.glsl>
uniform mediump vec2 u_mosaicSize;
uniform mediump float u_patternFactor;
varying mediump vec2 v_tileTextureCoord;
varying mediump vec4 v_tlbr;
#endif
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
void main()
{
#pragma main
v_color = color * opacity;
#ifdef ID
v_id = u_id / 255.0;
#endif
#ifdef PATTERN
float patternWidth = nextPOT(tlbr.z - tlbr.x);
float patternHeight = nextPOT(tlbr.w - tlbr.y);
float scaleX = 1.0 / (patternWidth * u_patternFactor);
float scaleY = 1.0 / (patternHeight * u_patternFactor);
mat3 patterMat = mat3(scaleX, 0.0,    0.0,
0.0,    -scaleY, 0.0,
0.0,    0.0,    1.0);
v_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;
v_tlbr             = tlbr / u_mosaicSize.xyxy;
#endif
vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},icon:{"icon.frag":`precision mediump float;
uniform lowp sampler2D u_texture;
#ifdef SDF
uniform lowp vec4 u_color;
uniform lowp vec4 u_outlineColor;
#endif
varying mediump vec2 v_tex;
varying lowp float v_opacity;
varying mediump vec2 v_size;
varying lowp vec4 v_color;
#ifdef SDF
varying mediump flaot v_halo_width;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
#include <util/encoding.glsl>
vec4 mixColors(vec4 color1, vec4 color2) {
float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);
vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);
return vec4(compositeColor, compositeAlpha);
}
void main()
{
#ifdef SDF
lowp vec4 fillPixelColor = v_color;
float d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;
const float softEdgeRatio = 0.248062016;
float size = max(v_size.x, v_size.y);
float dist = d * softEdgeRatio * size;
fillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);
if (v_halo_width > 0.25) {
lowp vec4 outlinePixelColor = u_outlineColor;
const float outlineLimitRatio = (16.0 / 86.0);
float clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));
outlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);
gl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);
}
else {
gl_FragColor = v_opacity * fillPixelColor;
}
#else
lowp vec4 texColor = texture2D(u_texture, v_tex);
gl_FragColor = v_opacity * texColor;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"icon.vert":`attribute vec2 a_pos;
attribute vec2 a_vertexOffset;
attribute vec4 a_texAngleRange;
attribute vec4 a_levelInfo;
attribute float a_opacityInfo;
#pragma header
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
#ifdef SDF
varying mediump float v_halo_width;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump vec2 u_iconTranslation;
uniform vec2 u_mosaicSize;
uniform mediump float u_depth;
uniform mediump float u_mapRotation;
uniform mediump float u_level;
uniform lowp float u_keepUpright;
uniform mediump float u_fadeDuration;
varying mediump vec2 v_tex;
varying lowp float v_opacity;
varying mediump vec2 v_size;
const float C_OFFSET_PRECISION = 1.0 / 8.0;
const float C_256_TO_RAD = 3.14159265359 / 128.0;
const float C_DEG_TO_RAD = 3.14159265359 / 180.0;
const float tileCoordRatio = 1.0 / 8.0;
uniform highp float u_time;
void main()
{
#pragma main
v_color = color;
v_opacity = opacity;
#ifdef SDF
v_halo_width = halo_width;
#endif
float modded = mod(a_opacityInfo, 128.0);
float targetOpacity = (a_opacityInfo - modded) / 128.0;
float startOpacity = modded / 127.0;
float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);
v_opacity *= interpolatedOpacity;
mediump float a_angle         = a_levelInfo[1];
mediump float a_minLevel      = a_levelInfo[2];
mediump float a_maxLevel      = a_levelInfo[3];
mediump vec2 a_tex            = a_texAngleRange.xy;
mediump float delta_z = 0.0;
mediump float rotated = mod(a_angle + u_mapRotation, 256.0);
delta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));
delta_z += 1.0 - step(a_minLevel, u_level);
delta_z += step(a_maxLevel, u_level);
delta_z += step(v_opacity, 0.0);
vec2 offset = C_OFFSET_PRECISION * a_vertexOffset;
v_size = abs(offset);
#ifdef SDF
offset = (120.0 / 86.0) * offset;
#endif
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);
#ifdef ID
v_id = u_id / 255.0;
#endif
v_tex = a_tex.xy / u_mosaicSize;
}`},line:{"line.frag":`precision lowp float;
varying mediump vec2 v_normal;
varying highp float v_accumulatedDistance;
varying mediump float v_lineHalfWidth;
varying lowp vec4 v_color;
varying mediump float v_blur;
#if defined (PATTERN) || defined(SDF)
varying mediump vec4 v_tlbr;
varying mediump vec2 v_patternSize;
varying mediump float v_widthRatio;
uniform sampler2D u_texture;
uniform mediump float u_antialiasing;
#endif
#ifdef SDF
#include <util/encoding.glsl>
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
mediump float fragDist = length(v_normal) * v_lineHalfWidth;
lowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);
#ifdef PATTERN
mediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));
mediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);
mediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));
lowp vec4 color = texture2D(u_texture, texCoord);
gl_FragColor = alpha * v_color[3] * color;
#elif defined(SDF)
mediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));
mediump float relativeTexY =  0.5 + 0.25 * v_normal.y;
mediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));
mediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;
float dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);
gl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;
#else
gl_FragColor = alpha * v_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"line.vert":`precision mediump float;
attribute vec2 a_pos;
attribute vec4 a_extrude_offset;
attribute vec4 a_dir_normal;
attribute vec2 a_accumulatedDistance;
#pragma header
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump float u_zoomFactor;
uniform mediump vec2 u_lineTranslation;
uniform mediump float u_antialiasing;
uniform mediump float u_depth;
varying mediump vec2 v_normal;
varying highp float v_accumulatedDistance;
const float scale = 1.0 / 31.0;
const mediump float tileCoordRatio = 8.0;
#if defined (SDF)
const mediump float sdfPatternHalfWidth = 15.5;
#endif
#if defined (PATTERN) || defined(SDF)
uniform mediump vec2 u_mosaicSize;
varying mediump vec4 v_tlbr;
varying mediump vec2 v_patternSize;
varying mediump float v_widthRatio;
#endif
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
varying mediump float v_lineHalfWidth;
varying mediump float v_blur;
void main()
{
#pragma main
v_color = color * opacity;
v_blur = blur + u_antialiasing;
v_normal = a_dir_normal.zw * scale;
#if defined (PATTERN) || defined(SDF)
v_tlbr          = tlbr / u_mosaicSize.xyxy;
v_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);
#if defined (PATTERN)
v_widthRatio = width / v_patternSize.y;
#else
v_widthRatio = width / sdfPatternHalfWidth / 2.0;
#endif
#endif
v_lineHalfWidth = (width + u_antialiasing) * 0.5;
mediump vec2 dir = a_dir_normal.xy * scale;
mediump vec2 offset_ = a_extrude_offset.zw * scale * offset;
mediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
#if defined (PATTERN) || defined(SDF)
v_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);
#endif
#ifdef ID
v_id = u_id / 255.0;
#endif
}`},outline:{"outline.frag":`varying lowp vec4 v_color;
varying mediump vec2 v_normal;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
lowp float dist = abs(v_normal.y);
lowp float alpha = smoothstep(1.0, 0.0, dist);
gl_FragColor = alpha * v_color;
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"outline.vert":`attribute vec2 a_pos;
attribute vec2 a_offset;
attribute vec2 a_xnormal;
#pragma header
varying lowp vec4 v_color;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump vec2 u_fillTranslation;
uniform mediump float u_depth;
uniform mediump float u_outline_width;
varying lowp vec2 v_normal;
const float scale = 1.0 / 15.0;
void main()
{
#pragma main
v_color = color * opacity;
#ifdef ID
v_id = u_id / 255.0;
#endif
v_normal = a_xnormal;
mediump vec2 dist = u_outline_width * scale * a_offset;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},text:{"text.frag":`uniform lowp sampler2D u_texture;
varying lowp vec2 v_tex;
varying lowp vec4 v_color;
varying mediump float v_edgeWidth;
varying mediump float v_edgeDistance;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
lowp float dist = texture2D(u_texture, v_tex).a;
mediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);
gl_FragColor = alpha * v_color;
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"text.vert":`attribute vec2 a_pos;
attribute vec2 a_vertexOffset;
attribute vec4 a_texAngleRange;
attribute vec4 a_levelInfo;
attribute float a_opacityInfo;
#pragma header
varying lowp vec4 v_color;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump vec2 u_textTranslation;
uniform vec2 u_mosaicSize;
uniform mediump float u_depth;
uniform mediump float u_mapRotation;
uniform mediump float u_level;
uniform lowp float u_keepUpright;
uniform mediump float u_fadeDuration;
varying lowp vec2 v_tex;
const float offsetPrecision = 1.0 / 8.0;
const mediump float edgePos = 0.75;
uniform mediump float u_antialiasingWidth;
varying mediump float v_edgeDistance;
varying mediump float v_edgeWidth;
uniform lowp float u_halo;
const float sdfFontScale = 1.0 / 24.0;
const float sdfPixel = 3.0;
uniform highp float u_time;
void main()
{
#pragma main
if (u_halo > 0.5)
{
v_color = halo_color * opacity;
halo_width *= sdfPixel;
halo_blur *= sdfPixel;
}
else
{
v_color = color * opacity;
halo_width = 0.0;
halo_blur = 0.0;
}
float modded = mod(a_opacityInfo, 128.0);
float targetOpacity = (a_opacityInfo - modded) / 128.0;
float startOpacity = modded / 127.0;
float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);
v_color *= interpolatedOpacity;
mediump float a_angle       = a_levelInfo[1];
mediump float a_minLevel    = a_levelInfo[2];
mediump float a_maxLevel    = a_levelInfo[3];
mediump vec2 a_tex          = a_texAngleRange.xy;
mediump float a_visMinAngle    = a_texAngleRange.z;
mediump float a_visMaxAngle    = a_texAngleRange.w;
mediump float delta_z = 0.0;
mediump float angle = mod(a_angle + u_mapRotation, 256.0);
if (a_visMinAngle < a_visMaxAngle)
{
delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));
}
else
{
delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));
}
delta_z += 1.0 - step(a_minLevel, u_level);
delta_z += step(a_maxLevel, u_level);
delta_z += step(v_color[3], 0.0);
v_tex = a_tex.xy / u_mosaicSize;
#ifdef ID
v_id = u_id / 255.0;
#endif
v_edgeDistance = edgePos - halo_width / size;
v_edgeWidth = (u_antialiasingWidth + halo_blur) / size;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);
}`},util:{"encoding.glsl":`const vec4 rgba2float_factors = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, rgba2float_factors);
}`,"util.glsl":`float nextPOT(in float x) {
return pow(2.0, ceil(log2(abs(x))));
}`}};function Wr(r){let t=Vr;return r.split("/").forEach(e=>{t&&(t=t[e])}),t}const Xr=new yr(Wr);function tt(r){return Xr.resolveIncludes(r)}const di=r=>Rt({ID:r.id,PATTERN:r.pattern}),Hr={shaders:r=>({vertexShader:di(r)+tt("background/background.vert"),fragmentShader:di(r)+tt("background/background.frag")})},ci=r=>Rt({ID:r.id}),qr={shaders:r=>({vertexShader:ci(r)+tt("circle/circle.vert"),fragmentShader:ci(r)+tt("circle/circle.frag")})},_i=r=>Rt({ID:r.id,PATTERN:r.pattern}),Yr={shaders:r=>({vertexShader:_i(r)+tt("fill/fill.vert"),fragmentShader:_i(r)+tt("fill/fill.frag")})},fi=r=>Rt({ID:r.id}),jr={shaders:r=>({vertexShader:fi(r)+tt("outline/outline.vert"),fragmentShader:fi(r)+tt("outline/outline.frag")})},pi=r=>Rt({ID:r.id,SDF:r.sdf}),Kr={shaders:r=>({vertexShader:pi(r)+tt("icon/icon.vert"),fragmentShader:pi(r)+tt("icon/icon.frag")})},mi=r=>Rt({ID:r.id,PATTERN:r.pattern,SDF:r.sdf}),Zr={shaders:r=>({vertexShader:mi(r)+tt("line/line.vert"),fragmentShader:mi(r)+tt("line/line.frag")})},gi=r=>Rt({ID:r.id}),Qr={shaders:r=>({vertexShader:gi(r)+tt("text/text.vert"),fragmentShader:gi(r)+tt("text/text.frag")})};class Jr{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(t=>t.dispose()),this._programByKey.clear()}getMaterialProgram(t,e,i){const s=e.key<<3|this._getMaterialOptionsValue(e.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const n=this._getProgramTemplate(e.type),{shaders:a}=n,{vertexShader:o,fragmentShader:h}=a(i),l=e.getShaderHeader(),d=e.getShaderMain(),c=o.replace("#pragma header",l).replace("#pragma main",d),_=t.programCache.acquire(c,h,e.getAttributeLocations());return this._programByKey.set(s,_),_}_getMaterialOptionsValue(t,e){switch(t){case K.BACKGROUND:{const i=e;return(i.pattern?1:0)<<1|(i.id?1:0)}case K.FILL:{const i=e;return(i.pattern?1:0)<<1|(i.id?1:0)}case K.OUTLINE:return e.id?1:0;case K.LINE:{const i=e;return(i.sdf?1:0)<<2|(i.pattern?1:0)<<1|(i.id?1:0)}case K.ICON:{const i=e;return(i.sdf?1:0)<<1|(i.id?1:0)}case K.CIRCLE:return e.id?1:0;case K.TEXT:return e.id?1:0;default:return 0}}_getProgramTemplate(t){switch(t){case K.BACKGROUND:return Hr;case K.CIRCLE:return qr;case K.FILL:return Yr;case K.ICON:return Kr;case K.LINE:return Zr;case K.OUTLINE:return jr;case K.TEXT:return Qr;default:return null}}}const bi={shaders:{vertexShader:J("bitBlit/bitBlit.vert"),fragmentShader:J("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class is{constructor(){this._initialized=!1}dispose(){this._program=ct(this._program),this._vertexArrayObject=ct(this._vertexArrayObject)}render(t,e,i,s){t&&(this._initialized||this._initialize(t),t.setBlendFunctionSeparate(R.ONE,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA),t.bindVAO(this._vertexArrayObject),t.useProgram(this._program),e.setSamplingMode(i),t.bindTexture(e,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),t.drawArrays(X.TRIANGLE_STRIP,0,4),t.bindTexture(null,0),t.bindVAO())}_initialize(t){if(this._initialized)return!0;const e=se(t,bi);if(!e)return!1;const i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;const s=bi.attributes,n=new Bt(t,s,wr,{geometry:gt.createVertex(t,bt.STATIC_DRAW,i)});return this._program=e,this._vertexArrayObject=n,this._initialized=!0,!0}}const tn=r=>{let t="";t+=r[0].toUpperCase();for(let e=1;e<r.length;e++){const i=r[e];i===i.toUpperCase()?(t+="_",t+=i):t+=i.toUpperCase()}return t},vi=r=>{const t={};for(const e in r)t[tn(e)]=r[e];return Rt(t)},Ei=(r,t,e,i)=>{const s=r+r.substring(r.lastIndexOf("/")),n=t+t.substring(t.lastIndexOf("/"));return{attributes:e,shaders:{vertexShader:vi(i)+J(`${s}.vert`),fragmentShader:vi(i)+J(`${n}.frag`)}}},ss=r=>r===Q.HITTEST||r===Q.LABEL_ALPHA,en=r=>(ss(r)?1:0)|(r===Q.HIGHLIGHT?2:0),sn=({rendererInfo:r,drawPhase:t},e,i,s)=>`${e.getVariationHash()}-${s.join(".")}-${en(t)}-${r.getVariationHash()}-${D(i)&&i.join(".")}`,rn=(r,t,e,i)=>{const s=i.reduce((a,o)=>At(j({},a),{[o]:r.context.driverTest[o]}),{}),n=j(At(j(j({},t.getVariation()),r.rendererInfo.getVariation()),{highlight:r.drawPhase===Q.HIGHLIGHT,id:ss(r.drawPhase)}),s);if(D(e))for(const a of e)n[a]=!0;return n};class nn{constructor(t){this._rctx=t,this._programByKey=new Map}dispose(){this._programByKey.forEach(t=>t.dispose()),this._programByKey.clear()}getProgram(t,e,i=[],s=[]){const n=e.vsPath+"."+e.fsPath+JSON.stringify(i)+s.join(".");if(this._programByKey.has(n))return this._programByKey.get(n);const a=s.reduce((f,p)=>At(j({},f),{[p]:t.context.driverTest[p]}),{}),o=j(j({},i.map(f=>typeof f=="string"?{name:f,value:!0}:f).reduce((f,p)=>At(j({},f),{[p.name]:p.value}),{})),a),{vsPath:h,fsPath:l,attributes:d}=e,c=Ei(h,l,d,o),_=this._rctx.programCache.acquire(c.shaders.vertexShader,c.shaders.fragmentShader,c.attributes);if(!_)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(n,_),_}getMaterialProgram(t,e,i,s,n,a=["ignoresSamplerPrecision"]){const o=sn(t,e,n,a);if(this._programByKey.has(o))return this._programByKey.get(o);const h=rn(t,e,n,a),l=Ei(i,i,s,h),d=this._rctx.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(o,d),d}}class ve{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new it(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new it;let i=null,s=-1;for(let n=0;n<this._free.length;++n){const a=this._free[n];t<=a.width&&e<=a.height&&(i===null||a.y<=i.y&&a.x<=i.x)&&(i=a,s=n)}return i===null?new it:(this._free.splice(s,1),i.width<i.height?(i.width>t&&this._free.push(new it(i.x+t,i.y,i.width-t,e)),i.height>e&&this._free.push(new it(i.x,i.y+e,i.width,i.height-e))):(i.width>t&&this._free.push(new it(i.x+t,i.y,i.width-t,i.height)),i.height>e&&this._free.push(new it(i.x,i.y+e,t,i.height-e))),new it(i.x,i.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const i=this._free[e];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}const an=256,on=r=>Math.floor(r/256);function ln(r){const t=new Set;for(const e of r)t.add(on(e));return t}function hn(r,t,e){return r.has(t)||r.set(t,e().then(()=>{r.delete(t)}).catch(i=>{r.delete(t),Fs(i)})),r.get(t)}const un=r=>({rect:new it(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:r,sdf:!0});class dn{constructor(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=i,this._binPack=new ve(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const t=[117,149,181,207,207,181,149,117],e=[];for(let s=0;s<t.length;s++){const n=t[s];for(let a=0;a<11;a++)e.push(n)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)};this._recordGlyph(i)}async getGlyphItems(t,e,i){const s=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map(n=>this._getMosaicItem(s,t,n))}bind(t,e,i,s){const n=this._getTexture(t,i);n.setSamplingMode(e),this._dirties[i]&&(n.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(n,s)}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_getTexture(t,e){return this._textures[e]||(this._textures[e]=new H(t,{pixelFormat:y.ALPHA,dataType:O.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[e]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,e,i){const s=ln(e),n=[];s.forEach(a=>{n.push(this._fetchRange(t,a,i))}),await Promise.all(n)}async _fetchRange(t,e,i){if(e>an)return null;const s=t+e;return hn(this._rangePromises,s,()=>this._glyphSource.getRange(t,e,i))}_getMosaicItem(t,e,i){if(!t[i]){const s=this._glyphSource.getGlyph(e,i);if(!s||!s.metrics)return un(i);const n=this._recordGlyph(s),a=this._currentPage,o=s.metrics;t[i]={rect:n,page:a,metrics:o,code:i,sdf:!0},this._invalidate()}return t[i]}_recordGlyph(t){const e=t.metrics;let i;if(e.width===0)i=new it(0,0,0,0);else{const n=e.width+6,a=e.height+2*3;i=this._binPack.allocate(n,a),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new ve(this.width-4,this.height-4),i=this._binPack.allocate(n,a));const o=this._glyphData[this._currentPage],h=t.bitmap;let l,d;if(h)for(let c=0;c<a;c++){l=n*c,d=this.width*(i.y+c)+i.x;for(let _=0;_<n;_++)o[d+_]=h[l+_]}ge("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),s=new ImageData(this.width,this.height),n=s.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let a=0;a<t.length;++a)n[4*a+0]=t[a],n[4*a+1]=0,n[4*a+2]=0,n[4*a+3]=255;i.putImageData(s,0,0),document.body.appendChild(e)}}class cn{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const i=e.getMessage();let s,n,a,o,h,l,d;for(;i.next();)switch(i.tag()){case 1:s=i.getUInt32();break;case 2:n=i.getBytes();break;case 3:a=i.getUInt32();break;case 4:o=i.getUInt32();break;case 5:h=i.getSInt32();break;case 6:l=i.getSInt32();break;case 7:d=i.getUInt32();break;default:i.skip()}i.release(),s&&(this._metrics[s]={width:a,height:o,left:h,top:l,advance:d},this._bitmaps[s]=n);break}default:e.skip()}e.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class _n{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class fn{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e,i){const s=this._getFontStack(t);if(s.getRange(e))return Promise.resolve();const n=256*e,a=n+255,o=this._baseURL.replace("{fontstack}",t).replace("{range}",n+"-"+a);return ie(o,j({responseType:"array-buffer"},i)).then(h=>{s.addRange(e,new cn(new Rs(new Uint8Array(h.data),new DataView(h.data))))})}getGlyph(t,e){const i=this._getFontStack(t);if(!i)return;const s=Math.floor(e/256);if(s>256)return;const n=i.getRange(s);return n?{metrics:n.getMetrics(e),bitmap:n.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new _n),e}}const Ht=1e20;class pn{constructor(t){this.size=t;const e=document.createElement("canvas");e.width=e.height=t,this._context=e.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,e,i=31){this._initSVG();const s=this.createSVGString(t);return new Promise((n,a)=>{const o=new Image;o.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),o.onload=()=>{o.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(o,0,0,this.size,this.size);const l=this._context.getImageData(0,0,this.size,this.size),d=new Uint8Array(this.size*this.size*4);for(let c=0;c<this.size*this.size;c++){const _=l.data[4*c+3]/255;this._gridOuter[c]=_===1?0:_===0?Ht:Math.max(0,.5-_)**2,this._gridInner[c]=_===1?Ht:_===0?0:Math.max(0,_-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let c=0;c<this.size*this.size;c++){const _=this._gridOuter[c]-this._gridInner[c];dr(.5-_/(2*i),d,4*c)}n(d)};const h=e&&e.signal;h&&Bs(h,()=>a(Xi()))})}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}}createSVGString(t){this._initSVG();const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d",t),this._svg.appendChild(e);const i=e.getBBox(),s=i.width/i.height,n=this.size/2;let a,o,h,l;if(s>1){o=a=n/i.width;const f=n*(1/s);h=this.size/4,l=n-f/2}else a=o=n/i.height,h=n-n*s/2,l=this.size/4;const d=-i.x*a+h,c=-i.y*o+l;e.setAttribute("style",`transform: matrix(${a}, 0, 0, ${o}, ${d}, ${c})`);const _=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(e),_}_edt(t,e,i){const s=this._f,n=this._d,a=this._v,o=this._z;for(let h=0;h<e;h++){for(let l=0;l<i;l++)s[l]=t[l*e+h];this._edt1d(s,n,a,o,i);for(let l=0;l<i;l++)t[l*e+h]=n[l]}for(let h=0;h<i;h++){for(let l=0;l<e;l++)s[l]=t[h*e+l];this._edt1d(s,n,a,o,e);for(let l=0;l<e;l++)t[h*e+l]=Math.sqrt(n[l])}}_edt1d(t,e,i,s,n){i[0]=0,s[0]=-Ht,s[1]=+Ht;for(let a=1,o=0;a<n;a++){let h=(t[a]+a*a-(t[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);for(;h<=s[o];)o--,h=(t[a]+a*a-(t[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);o++,i[o]=a,s[o]=h,s[o+1]=+Ht}for(let a=0,o=0;a<n;a++){for(;s[o+1]<a;)o++;e[a]=(a-i[o])*(a-i[o])+t[i[o]]}}}function St(r){return r&&r.type==="static"}class $e{constructor(t,e,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=i,this._requestRender=t,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new ve(this._pageWidth,this._pageHeight);const n=Math.floor(this._pageWidth),a=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,s,n,a){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let o,h,l;if(St(i))[o,h,l]=this._allocateImage(e[0],e[1]);else{o=new it(0,0,e[0],e[1]),h=this._mosaicPages.length;const c=void 0;this._mosaicPages.push({mosaicsData:i,size:e,dirty:!0,texture:c})}if(o.width<=0||o.height<=0)return null;const d={rect:o,width:e[0],height:e[1],sdf:n,simplePattern:a,pixelRatio:1,page:h};return this._mosaicRects.set(t,d),St(i)&&this._copy({rect:o,spriteSize:e,spriteData:i.data,page:h,pageSize:l,repeat:s,sdf:n}),d}hasItemsToProcess(){return this._spriteCopyQueue.length!==0}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e}getMosaicItemPosition(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const s=e.width,n=e.height,a=Wt,o=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+a)/o[0],(i.y+a)/o[1]],br:[(i.x+a+s)/o[0],(i.y+a+n)/o[1]],page:e.page}}bind(t,e,i=0,s=0){const n=this._mosaicPages[i],a=n.mosaicsData;let o=n.texture;if(o||(o=mn(t,a,n.size),n.texture=o),o.setSamplingMode(e),St(a))t.bindTexture(o,s),n.dirty&&(o.setData(new Uint8Array(a.data.buffer)),o.generateMipmap());else{const h=a.data,l=h.bindFrame(t,o,s);D(this._requestRender)&&l&&h.frameCount>0&&this._requestRender.requestRender(),h.bindFrame(t,o,s)}n.dirty=!1}static _copyBits(t,e,i,s,n,a,o,h,l,d,c){let _=s*e+i,f=h*a+o;if(c){f-=a;for(let p=-1;p<=d;p++,_=((p+d)%d+s)*e+i,f+=a)for(let u=-1;u<=l;u++)n[f+u]=t[_+(u+l)%l]}else for(let p=0;p<d;p++){for(let u=0;u<l;u++)n[f+u]=t[_+u];_+=e,f+=a}}_copy(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!St(e.mosaicsData))throw new z("mapview-invalid-resource","unsuitable data type!");const s=t.spriteData,n=i.data;n&&s||console.error("Source or target images are uninitialized!"),$e._copyBits(s,t.spriteSize[0],0,0,n,t.pageSize[0],t.rect.x+Wt,t.rect.y+Wt,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0}_allocateImage(t,e){t+=2*Wt,e+=2*Wt;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const n=2**Math.ceil(oi(t)),a=2**Math.ceil(oi(e)),o=new it(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[n,a],dirty:!0,texture:void 0}),[o,this._mosaicPages.length-1,[n,a]]}const s=this._binPack.allocate(t,e);if(s.width<=0){const n=this._mosaicPages[this._currentPage];return!n.dirty&&St(n.mosaicsData)&&(n.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new ve(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;St(i)||i.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()}}function mn(r,t,e){return St(t)?new H(r,{pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,width:e[0],height:e[1]},new Uint8Array(t.data.buffer)):new H(r,{pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,samplingMode:S.LINEAR,wrapMode:U.CLAMP_TO_EDGE,width:e[0],height:e[1]},null)}const rs=new Uint32Array(256);for(let r=0;r<256;r++){let t=r;for(let e=0;e<8;e++)t=(1&t)!=0?3988292384^t>>>1:t>>>1;rs[r]=t}function gn(r,t=0,e=r.length-t){let i=-1;for(let s=t,n=t+e;s<n;s++)i=i>>>8^rs[255&(i^r[s])];return-1^i}const bn=new z("Not a PNG"),Ti=new z("Not an animated PNG"),Ne=new Uint8Array([137,80,78,71,13,10,26,10]);function ns(r){const t=r.constructor===Uint8Array?r:new Uint8Array(r);return!Ne.some((e,i)=>e!==t[i])}function vn(r){const t=new Uint8Array(r);if(!ns(t))return!1;let e=!1;return Le(t,i=>!(e=i==="acTL")),e}class Ge{constructor(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}static async create(t,e){const i=new Ge;try{await i._load(t,e)}catch(s){if(!_t(s))return new z("invalid-resource",`Could not load PNG: ${s.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(t,e,i){t.bindTexture(e,i);const s=this.frameChanged();if(!s)return!1;const n=this.currentFrame,a=n.frameData,o=e.descriptor;return(n.left||n.top||n.width!==o.width||n.height!==o.height)&&e.setData(null),e.updateData(0,n.left,n.top,n.width,n.height,a),this.updateUsedFrame(),s}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(t,e){try{const i=xn(this,t);if(i!==this)return i;this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,await Promise.all(this.frames.map(s=>s.createImage(this._resizeCanvas)))}catch(i){if(!_t(i))return new z("invalid-resource","Could not parse PNG")}this.play()}_play(){let t,e;if(this.playSpeed===0)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const i=this.frames[this.currentFrameNumber];this.currentFrame={frameData:i.imageData,top:i.top,left:i.left,width:i.width,height:i.height},this.timerID=window.setTimeout(()=>this._play(),t)}}class En{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}async createImage(t){if(this.imageData===null)return new Promise((e,i)=>{const s=URL.createObjectURL(this.data),n=document.createElement("img");n.onload=()=>{URL.revokeObjectURL(s),this.imageData=Tn(n,t),e()},n.onerror=()=>{URL.revokeObjectURL(s),this.imageData=null,i(new Error("Image creation error"))},n.src=s})}}function Tn(r,t){t.width=r.width,t.height=r.height;const e=t.getContext("2d");e.drawImage(r,0,0,r.width,r.height);const i=e.getImageData(0,0,r.width,r.height),s=new Uint8Array(i.data);let n;for(let a=0;a<s.length;a+=4)n=s[a+3]/255,s[a]=s[a]*n,s[a+1]=s[a+1]*n,s[a+2]=s[a+2]*n;return new ImageData(new Uint8ClampedArray(s.buffer),r.width,r.height)}function xn(r,t){const e=new Uint8Array(t);if(Ne.some((c,_)=>c!==e[_]))return bn;let i=!1;if(Le(e,c=>!(i=c==="acTL")),!i)return Ti;const s=[],n=[];let a=null,o=null,h=0;if(Le(e,(c,_,f,p)=>{const u=new DataView(_.buffer);switch(c){case"IHDR":a=_.subarray(f+8,f+8+p),r.width=u.getUint32(f+8),r.height=u.getUint32(f+12);break;case"acTL":r.numPlays=u.getUint32(f+8+4);break;case"fcTL":{o&&(r.frames.push(o),h++),o=new En,o.width=u.getUint32(f+8+4),o.height=u.getUint32(f+8+8),o.left=u.getUint32(f+8+12),o.top=u.getUint32(f+8+16);const m=u.getUint16(f+8+20);let E=u.getUint16(f+8+22);E===0&&(E=100),o.delay=1e3*m/E,o.delay<=10&&(o.delay=100),r.playTime+=o.delay,o.disposeOp=u.getUint8(f+8+24),o.blendOp=u.getUint8(f+8+25),o.dataParts=[],h===0&&o.disposeOp===2&&(o.disposeOp=1);break}case"fdAT":o&&o.dataParts.push(_.subarray(f+8+4,f+8+p));break;case"IDAT":o&&o.dataParts.push(_.subarray(f+8,f+8+p));break;case"IEND":n.push(xi(_,f,12+p));break;default:s.push(xi(_,f,12+p))}}),r.frames.length===0)return Ti;r.frameCount=r.frames.length;const l=new Blob(s),d=new Blob(n);return r.frames.forEach(c=>{let _=[];_.push(Ne),a.set(yi(c.width),0),a.set(yi(c.height),4),_.push(wi("IHDR",a)),_.push(l),c.dataParts.forEach(f=>_.push(wi("IDAT",f))),_.push(d),c.data=new Blob(_,{type:"image/png"}),delete c.dataParts,_=null}),r}function Le(r,t){const e=new DataView(r.buffer);let i,s,n,a=8;do s=e.getUint32(a),i=wn(r,a+4,4),n=t(i,r,a,s),a+=12+s;while(n!==!1&&i!=="IEND"&&a<r.length)}function wn(r,t,e){const i=Array.prototype.slice.call(r.subarray(t,t+e));return String.fromCharCode.apply(String,i)}function yn(r){const t=new Uint8Array(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}function xi(r,t,e){const i=new Uint8Array(e);return i.set(r.subarray(t,t+e)),i}function wi(r,t){const e=r.length+t.length,i=new Uint8Array(e+8),s=new DataView(i.buffer);s.setUint32(0,t.length),i.set(yn(r),4),i.set(t,8);const n=gn(i,4,e);return s.setUint32(e+4,n),i}function yi(r){return new Uint8Array([r>>>24&255,r>>>16&255,r>>>8&255,255&r])}const Dt={GCExt:249,COMMENT:254,APPExt:255,UNKNOWN:1,IMAGE:44,EOF:59,EXT:33};function as(r){if(!r||r.byteLength===0)return!1;const t=r.constructor===Uint8Array?r:new Uint8Array(r);return t[0]===71&&t[1]===73&&t[2]===70&&t[3]===56}function Fn(r){if(!r||r.byteLength===0)return!1;const t=new Uint8Array(r);if(!as(t))return!1;let e=0;for(let i=0,s=t.length-9;i<s;++i)if(t[i]===0&&t[i+1]===33&&t[i+2]===249&&t[i+3]===4&&t[i+8]===0&&(t[i+9]===44||t[i+9]===33)&&(e++,e>1))return!0;return!1}class ke{constructor(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}static async create(t,e){const i=new ke;try{await i._load(t,e)}catch(s){if(!_t(s))return new z("invalid-resource",`Could not load PNG: ${s.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(t,e,i){t.bindTexture(e,i);const s=this.frameChanged();if(s){const n=this.currentFrame,a=n.frameData;e.updateData(0,0,0,n.width,n.height,a),this.updateUsedFrame()}return s}seekFrame(t){clearTimeout(this.timerID),this.currentFrameNumber=t%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}seek(t){clearTimeout(this.timerID),t<0&&(t=0),t*=1e3,t%=this.length;let e=0;for(;t>this.frames[e].time+this.frames[e].delay&&e<this.frames.length;)e+=1;this.currentFrameNumber=e,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(t,e){try{this.loading=!0,await this._parse(t,e),this.loading=!1,this.play()}catch(i){if(!_t(i))return new z("invalid-resource","Could not parse gif!")}}_parse(t,e){const i=new Rn(t);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);const s=i.data[i.pos++];return this.globalColourCount=1<<1+(7&s),i.pos++,i.pos++,128&s&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),new Promise((n,a)=>{setTimeout(()=>this._parseBlock(i,n,a,e),0)})}async _parseBlock(t,e,i,s){if(s&&s.signal&&As(s.signal))return void i(Xi());const n=t.data[t.pos++];if(n===Dt.IMAGE){if(this._parseImg(t),this.firstFrameOnly)return this._finishedLoading(),void e()}else{if(n===Dt.EOF)return this._finishedLoading(),void e();this._parseExt(t)}typeof this.onprogress=="function"&&this.onprogress({bytesRead:t.pos,totalBytes:t.data.length,frame:this.frames.length}),setTimeout(()=>this._parseBlock(t,e,i,s),0)}_parseColourTable(t,e){const i=[];for(let s=0;s<t;s++)i.push([e.data[e.pos++],e.data[e.pos++],e.data[e.pos++]]);return i}_parseImg(t){const e=n=>{const a=this.pixelBufSize/n;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let o=0;for(let h=0;h<4;h++)for(let l=this.interlaceOffsets[h];l<a;l+=this.interlaceSteps[h])this.deinterlaceBuf.set(this.pixelBuf.subarray(o,o+n),l*n),o+=n},i={};this.frames.push(i),i.disposalMethod=this.disposalMethod,i.time=this.length,i.delay=10*this.delayTime,this.length+=i.delay,this.transparencyGiven?i.transparencyIndex=this.transparencyIndex:i.transparencyIndex=void 0,i.leftPos=t.data[t.pos++]+(t.data[t.pos++]<<8),i.topPos=t.data[t.pos++]+(t.data[t.pos++]<<8),i.width=t.data[t.pos++]+(t.data[t.pos++]<<8),i.height=t.data[t.pos++]+(t.data[t.pos++]<<8);const s=t.data[t.pos++];i.localColourTableFlag=!!(128&s),i.localColourTableFlag&&(i.localColourTable=this._parseColourTable(1<<1+(7&s),t)),this.pixelBufSize!==i.width*i.height&&(this.pixelBuf=new Uint8Array(i.width*i.height),this.pixelBufSize=i.width*i.height),this._lzwDecode(t.data[t.pos++],t.readSubBlocksB()),64&s?(i.interlaced=!0,e(i.width)):i.interlaced=!1,this._processFrame(i)}_lzwDecode(t,e){let i,s,n,a,o,h,l,d,c;n=s=0;let _=[];const f=1<<t,p=f+1;for(a=t+1,c=!1;!c;){for(h=o,o=0,i=0;i<a;i++)e[n>>3]&1<<(7&n)&&(o|=1<<i),n++;if(o===f){for(_=[],a=t+1,i=0;i<f;i++)_[i]=[i];_[f]=[],_[p]=null}else{if(o===p)return void(c=!0);for(o>=_.length?_.push(_[h].concat(_[h][0])):h!==f&&_.push(_[h].concat(_[o][0])),l=_[o],d=l.length,i=0;i<d;i++)this.pixelBuf[s++]=l[i];_.length===1<<a&&a<12&&a++}}}_processFrame(t){t.image=document.createElement("canvas"),t.image.width=this.width,t.image.height=this.height,t.ctx=t.image.getContext("2d");const e=t.localColourTableFlag?t.localColourTable:this.globalColourTable;this.lastFrame===null&&(this.lastFrame=t);const i=this.lastFrame.disposalMethod===2||this.lastFrame.disposalMethod===3;i||t.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const s=t.ctx.getImageData(t.leftPos,t.topPos,t.width,t.height),n=t.transparencyIndex,a=s.data,o=t.interlaced?this.deinterlaceBuf:this.pixelBuf,h=o.length;let l,d,c=0;for(let _=0;_<h;_++)l=o[_],d=e[l],n!==l?(a[c++]=d[0],a[c++]=d[1],a[c++]=d[2],a[c++]=255):(i&&(a[c+3]=0),c+=4);t.ctx.putImageData(s,t.leftPos,t.topPos),this.lastFrame=t}_parseExt(t){const e=t.data[t.pos++];e===Dt.GCExt?this._parseGCExt(t):e===Dt.COMMENT?this.comment+=t.readSubBlocks():e===Dt.APPExt?this._parseAppExt(t):(e===Dt.UNKNOWN&&(t.pos+=13),t.readSubBlocks())}_parseAppExt(t){t.pos+=1,t.getString(8)==="NETSCAPE"?t.pos+=8:(t.pos+=3,t.readSubBlocks())}_parseGCExt(t){t.pos++;const e=t.data[t.pos++];this.disposalMethod=(28&e)>>2,this.transparencyGiven=!!(1&e),this.delayTime=t.data[t.pos++]+(t.data[t.pos++]<<8),this.transparencyIndex=t.data[t.pos++],t.pos++}_finishedLoading(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}_play(){let t,e;this.playSpeed!==0?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),e=this.currentFrameNumber,e-=1,e<0&&(e=this.frames.length-1),t=1*-this.frames[e].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout(()=>this._play(),t)):this.pause()}_setCurrentFrame(t){const e=this.frames[t];this.currentFrame={frameData:e.image,top:0,left:0,width:this.width,height:this.height}}}class Rn{constructor(t){this.pos=0,this.data=new Uint8ClampedArray(t),this.len=this.data.length}getString(t){let e="";for(;t--;)e+=String.fromCharCode(this.data[this.pos++]);return e}readSubBlocks(){let t,e,i="";do for(e=t=this.data[this.pos++];e--;)i+=String.fromCharCode(this.data[this.pos++]);while(t!==0&&this.pos<this.len);return i}readSubBlocksB(){let t,e;const i=[];do for(e=t=this.data[this.pos++];e--;)i.push(this.data[this.pos++]);while(t!==0&&this.pos<this.len);return i}}function Bn(r){switch(r.type){case"esriSMS":return`${r.style}.${r.path}`;case"esriSLS":return`${r.style}.${r.cap}`;case"esriSFS":return`${r.style}`;case"esriPFS":case"esriPMS":return r.imageData?`${r.imageData}${r.width}${r.height}`:`${r.url}${r.width}${r.height}`;default:return"mosaicHash"in r?r.mosaicHash:JSON.stringify(r)}}const Fi=Cs(),Ri="arial-unicode-ms-regular",Fe=126,os=re.getLogger("esri.views.2d.engine.webgl.TextureManager");async function An(r,t){const e=Zi(r);let i;const s=";base64,";if(e.includes(s)){const n=e.indexOf(s)+s.length,a=e.substring(n),o=atob(a),h=new Uint8Array(o.length);for(let l=0;l<o.length;l++)h[l]=o.charCodeAt(l);i=h.buffer}else try{const{data:n}=await ie(e,j({responseType:"array-buffer"},t));i=n}catch(n){if(!_t(n))return new z("mapview-invalid-resource",`Could not fetch requested resource at ${e}`)}return i}function Bi(r,t){const e=Math.round(yt(t)*window.devicePixelRatio),i=e>=128?2:4;return Math.min(r,e*i)}const Re=(r,t,e)=>os.error(new z(r,t,e));class Ve{constructor(t,e,i){this.mosaicType=t,this.page=e,this.sdf=i}static fromMosaic(t,e){return new Ve(t,e.page,e.sdf)}}class Sn{constructor(t,e){this.resourceManager=e,this._invalidFontsMap=new Map,this._sdfConverter=new pn(Fe),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Ss({concurrency:10,process:async(i,s)=>{Hi(s);try{return await ie(i,{responseType:"image",signal:s})}catch(n){throw _t(n)?n:new z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`,n)}}}),this._spriteMosaic=new $e(t,2048,2048,500),this._glyphSource=new fn(`${Os.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new dn(1024,1024,this._glyphSource),this._rasterizer=new Cr(e)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(t,e,i,s){if(N(t))return Re("mapview-null-resource","Unable to rasterize null resource"),null;switch(t.type){case"text":case"esriTS":{const n=await this._rasterizeText(t,i,s);return n.forEach(a=>this._setTextureBinding(oe.GLYPH,a)),{glyphMosaicItems:n}}default:{if(mr(t))return Re("mapview-invalid-type",`MapView does not support symbol type: ${t.type}`,t),null;const n=await this._rasterizeSpriteSymbol(t,e,s);return ye(n)&&n&&this._setTextureBinding(oe.SPRITE,n),{spriteMosaicItem:n}}}}bindTextures(t,e,i,s=!1){if(i.textureBinding===0)return;const n=this._bindingInfos[i.textureBinding-1],a=n.page,o=s?S.LINEAR_MIPMAP_LINEAR:S.LINEAR;switch(n.mosaicType){case oe.SPRITE:{const h=this.sprites.getWidth(a),l=this.sprites.getHeight(a),d=ft(Fi,h,l);return this._spriteMosaic.bind(t,o,a,ni),e.setUniform1i("u_texture",ni),void e.setUniform2fv("u_mosaicSize",d)}case oe.GLYPH:{const h=this.glyphs.width,l=this.glyphs.height,d=ft(Fi,h,l);return this._glyphMosaic.bind(t,o,a,ri),e.setUniform1i("u_texture",ri),void e.setUniform2fv("u_mosaicSize",d)}default:os.error("mapview-texture-manager",`Cannot handle unknown type ${n.mosaicType}`)}}_hashMosaic(t,e){return 1|t<<1|(e.sdf?1:0)<<2|e.page<<3}_setTextureBinding(t,e){const i=this._hashMosaic(t,e);if(!this._hashToBindingIndex.has(i)){const s=Ve.fromMosaic(t,e),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(s)}e.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(t,e,i){let s,n;if("cim"in t){const h=t;s=h.fontName,n=h.text}else{const h=t;s=Nr(h.font),n=h.text}const a=this._invalidFontsMap.has(s),o=e||gr(cr(n)[0]);try{return await this._glyphMosaic.getGlyphItems(a?Ri:s,o,i)}catch{return Re("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(s,!0),this._glyphMosaic.getGlyphItems(Ri,o,i)}}async _rasterizeSpriteSymbol(t,e,i){if(br(t))return null;const s=Bn(t);if(this._spriteMosaic.has(s))return this._spriteMosaic.getSpriteItem(s);if(ti(t)||vr(t))return this._handleAsyncResource(s,t,i);const n=1,a=this._rasterizer.rasterizeJSONResource(t,n);if(a){const{size:o,image:h,sdf:l,simplePattern:d}=a;return this._addItemToMosaic(s,o,{type:"static",data:h},le(t),l,d)}return new z("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(t,e,i){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let s;s=ti(e)?this._handleSVG(e,t,i):this._handleImage(e,t,i),this._ongoingRasterizations.set(t,s);try{await s,this._ongoingRasterizations.delete(t)}catch{this._ongoingRasterizations.delete(t)}return s}async _handleSVG(t,e,i){const s=[Fe,Fe],n=await this._sdfConverter.draw(t.path,i);return this._addItemToMosaic(e,s,{type:"static",data:new Uint32Array(n.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,e,i){const s=await An(t,i);if(ye(s)){const n=as(s),a=ns(s);if(!n&&!a)return new z("mapview-invalid-resource","Image data is neither GIF nor PNG!");let o;try{n&&Fn(s)?o=await ke.create(s,i):a&&vn(s)&&(o=await Ge.create(s,i))}catch(d){if(!_t(d))return new z("mapview-invalid-resource","Could not fetch requested resource!")}if(o&&ye(o))return this._addItemToMosaic(e,[o.width,o.height],{type:"animated",data:o},le(t),!1,!1);const h=new Blob([s],{type:n?"image/gif":"image/png"}),l=await this._imageFromBlob(h);if(l&&l instanceof HTMLImageElement){let d=l.width,c=l.height;t.type==="esriPMS"&&(d=Math.round(Bi(l.width,ei(t))),c=Math.round(l.height*(d/l.width)));const _="cim"in t?t.cim.colorSubstitutions:void 0,{size:f,sdf:p,image:u}=this._rasterizer.rasterizeImageResource(d,c,l,_);return this._addItemToMosaic(e,f,{type:"static",data:u},le(t),p,!1)}}return new z("mapview-invalid-resource","Could not handle resource!")}async _handleImage(t,e,i){if(Er(t)||Tr(t))return this._handleGIFOrPNG(t,e,i);const s=Zi(t);try{let a;const o=this.resourceManager.getResource(s);if(D(o))a=o;else{const{data:p}=await this._imageRequestQueue.push(s,j({},i));a=p}if(xr(s)){if("width"in t&&"height"in t)a.width=yt(t.width),a.height=yt(t.height);else if("cim"in t){var n;const p=t.cim;a.width=yt((n=p.width)!=null?n:p.scaleX*p.size),a.height=yt(p.size)}}if(!a.width||!a.height)return null;let h=a.width,l=a.height;t.type==="esriPMS"&&(h=Math.round(Bi(a.width,ei(t))),l=Math.round(a.height*(h/a.width)));const d="cim"in t?t.cim.colorSubstitutions:void 0,{size:c,sdf:_,image:f}=this._rasterizer.rasterizeImageResource(h,l,a,d);return this._addItemToMosaic(e,c,{type:"static",data:f},le(t),_,!1)}catch(a){if(!_t(a))return new z("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${a.message}`)}}async _imageFromBlob(t){const e=window.URL.createObjectURL(t);try{const{data:i}=await this._imageRequestQueue.push(e);return window.URL.revokeObjectURL(e),i}catch(i){if(window.URL.revokeObjectURL(e),!_t(i))return new z("mapview-invalid-resource",`Could not fetch requested resource at ${e}`);throw i}}_addItemToMosaic(t,e,i,s,n,a){return this._spriteMosaic.addSpriteItem(t,e,i,s,n,a)}}class ne{constructor(){this.name=this.constructor.name}createOptions(t,e){return null}}class On extends ne{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(t,e){if(!e.size)return;const{context:i,renderingOptions:s}=t;this._quad||(this._quad=new Vt(i,[0,0,1,0,0,1,1,1]));const n=i.getBoundFramebufferObject(),{x:a,y:o,width:h,height:l}=i.getViewport();e.bindTextures(i);const d=e.getBlock(Mr);if(N(d))return;const c=d.getFBO(i),_=d.getFBO(i,1);i.setViewport(0,0,e.size,e.size),this._computeDelta(t,_,s.labelsAnimationTime),this._updateAnimationState(t,_,c),i.bindFramebuffer(n),i.setViewport(a,o,h,l)}_computeDelta(t,e,i){const{context:s,painter:n,displayLevel:a}=t,o=n.materialManager.getProgram(t,this._desc,["delta"]);s.bindFramebuffer(e),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),s.useProgram(o),o.setUniform1i("u_maskTexture",Pr),o.setUniform1i("u_sourceTexture",Dr),o.setUniform1f("u_timeDelta",t.deltaTime),o.setUniform1f("u_animationTime",i),o.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}_updateAnimationState(t,e,i){const{context:s,painter:n}=t,a=n.materialManager.getProgram(t,this._desc,["update"]);s.bindTexture(e.colorTexture,1),s.useProgram(a),a.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const Cn=r=>r.replace("-","_").toUpperCase(),Ai=r=>`#define ${Cn(r)}
`;function Si(r){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:Ai(r)+J("blend/blend.vert"),fragmentShader:Ai(r)+J("blend/blend.frag")}}}const Oi=re.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Mn{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture=ct(this._backBufferTexture),this._quad=ct(this._quad)}draw(t,e,i,s,n){const{context:a,drawPhase:o}=t;if(this._setupShader(a),s&&s!=="normal"&&o!==Q.LABEL)return void this._drawBlended(t,e,i,s,n);const h=Si("normal"),l=a.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!l)return void Oi.error(new z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(l),e.setSamplingMode(i),a.bindTexture(e,0),l.setUniform1i("u_layerTexture",0),l.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA);const d=this._quad;d.draw(),d.unbind(),l.dispose()}_drawBlended(t,e,i,s,n){const{context:a,state:o,pixelRatio:h,inFadeTransition:l}=t,{size:d}=o,c=a.getBoundFramebufferObject();let _,f;if(D(c)){const g=c.descriptor;_=g.width,f=g.height}else _=Math.round(h*d[0]),f=Math.round(h*d[1]);this._createOrResizeTexture(t,_,f);const p=this._backBufferTexture;c.copyToTexture(0,0,_,f,0,0,p),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);const u=Si(s),m=a.programCache.acquire(u.shaders.vertexShader,u.shaders.fragmentShader,u.attributes);if(!m)return void Oi.error(new z("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));a.useProgram(m),p.setSamplingMode(i),a.bindTexture(p,0),m.setUniform1i("u_backbufferTexture",0),e.setSamplingMode(i),a.bindTexture(e,1),m.setUniform1i("u_layerTexture",1),m.setUniform1f("u_opacity",n),m.setUniform1f("u_inFadeOpacity",l?1:0),a.setBlendFunction(R.ONE,R.ZERO);const E=this._quad;E.draw(),E.unbind(),m.dispose(),a.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA)}_setupShader(t){this._quad||(this._quad=new Vt(t,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(t,e,i){const{context:s}=t;this._backBufferTexture!==null&&e===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(e,i):this._backBufferTexture=new H(s,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:e,height:i}),this._size[0]=e,this._size[1]=i)}}class Ci extends ne{constructor(t){super(),this.name=this.constructor.name,this.defines=[t]}dispose(){}bind({context:t,painter:e}){this._prev=t.getBoundFramebufferObject();const{width:i,height:s}=t.getViewport(),n=e.getFbos(i,s).effect0;t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}draw(t,e){const{context:i,painter:s}=t,n=s.getPostProcessingEffects(e),a=i.getBoundFramebufferObject();for(const{postProcessingEffect:o,effect:h}of n)o.draw(t,a,h);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,a.colorTexture,S.NEAREST),i.setStencilTestEnabled(!0)}}const ze=1,Pn=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],Dn=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],qt=256,Ft={outlineWidth:.7,outerHaloWidth:.7,innerHaloWidth:.7,outlinePosition:0},Be=re.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient");function In(r,t){t.fillColor[0]=r.color.r/255,t.fillColor[1]=r.color.g/255,t.fillColor[2]=r.color.b/255,t.fillColor[3]=r.color.a,r.haloColor?(t.outlineColor[0]=r.haloColor.r/255,t.outlineColor[1]=r.haloColor.g/255,t.outlineColor[2]=r.haloColor.b/255,t.outlineColor[3]=r.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=r.fillOpacity,t.outlineColor[3]*=r.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=Ft.outlineWidth,t.outerHaloWidth=Ft.outerHaloWidth,t.innerHaloWidth=Ft.innerHaloWidth,t.outlinePosition=Ft.outlinePosition}const Un=[0,0,0,0];class Nn{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:Ft.outlinePosition,outlineWidth:Ft.outlineWidth,innerHaloWidth:Ft.innerHaloWidth,outerHaloWidth:Ft.outerHaloWidth},this.shadeTexChanged=!0,this.texelData=new Uint8Array(4*qt),this.minMaxDistance=[0,0]}setHighlightOptions(t){const e=this._convertedHighlightOptions;In(t,e);const i=e.outlinePosition-e.outlineWidth/2-e.outerHaloWidth,s=e.outlinePosition-e.outlineWidth/2,n=e.outlinePosition+e.outlineWidth/2,a=e.outlinePosition+e.outlineWidth/2+e.innerHaloWidth,o=Math.sqrt(Math.PI/2)*ze,h=Math.abs(i)>o?Math.round(10*(Math.abs(i)-o))/10:0,l=Math.abs(a)>o?Math.round(10*(Math.abs(a)-o))/10:0;let d;h&&!l?Be.error("The outer rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!h&&l?Be.error("The inner rim of the highlight is "+l+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):h&&l&&Be.error("The highlight is "+Math.max(h,l)+"px away from the edge of the feature; consider reducing some width values.");const c=[void 0,void 0,void 0,void 0];function _(p,u,m){c[0]=(1-m)*p[0]+m*u[0],c[1]=(1-m)*p[1]+m*u[1],c[2]=(1-m)*p[2]+m*u[2],c[3]=(1-m)*p[3]+m*u[3]}const{texelData:f}=this;for(let p=0;p<qt;++p)d=i+p/(qt-1)*(a-i),d<i?(c[4*p+0]=0,c[4*p+1]=0,c[4*p+2]=0,c[4*p+3]=0):d<s?_(Un,e.outlineColor,(d-i)/(s-i)):d<n?[c[0],c[1],c[2],c[3]]=e.outlineColor:d<a?_(e.outlineColor,e.fillColor,(d-n)/(a-n)):[c[4*p+0],c[4*p+1],c[4*p+2],c[4*p+3]]=e.fillColor,f[4*p+0]=255*c[0],f[4*p+1]=255*c[1],f[4*p+2]=255*c[2],f[4*p+3]=255*c[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=a,this.shadeTexChanged=!0}applyHighlightOptions(t,e){this.shadeTex||(this.shadeTex=new H(t,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,width:qt,height:1,samplingMode:S.LINEAR})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,qt,1,this.texelData),this.shadeTexChanged=!1),t.bindTexture(this.shadeTex,ts),e.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const Ln={shaders:{vertexShader:J("highlight/textured.vert"),fragmentShader:J("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},zn={shaders:{vertexShader:J("highlight/textured.vert"),fragmentShader:J("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};class $n{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(t,e){t.bindTexture(e,Xt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Pn),t.bindVAO(this._resources.quadVAO),t.drawArrays(X.TRIANGLE_STRIP,0,4),t.bindVAO()}finalBlur(t,e){t.bindTexture(e,Xt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Dn),t.bindVAO(this._resources.quadVAO),t.drawArrays(X.TRIANGLE_STRIP,0,4),t.bindVAO()}renderHighlight(t,e,i){t.bindTexture(e,Xt),t.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(t,this._resources.highlightProgram),t.bindVAO(this._resources.quadVAO),t.setBlendingEnabled(!0),t.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),t.drawArrays(X.TRIANGLE_STRIP,0,4),t.bindVAO()}_initialize(t,e,i){this._width=e,this._height=i;const s=gt.createVertex(t,bt.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new Bt(t,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new $t("a_position",2,Pt.BYTE,0,4),new $t("a_texcoord",2,Pt.UNSIGNED_BYTE,2,4)]},{geometry:s}),a=se(t,Ln),o=se(t,zn);t.useProgram(a),a.setUniform1i("u_texture",Xt),a.setUniform1i("u_shade",ts),a.setUniform1f("u_sigma",ze),t.useProgram(o),o.setUniform1i("u_texture",Xt),o.setUniform1f("u_sigma",ze),this._resources={quadGeometry:s,quadVAO:n,highlightProgram:a,blurProgram:o}}setup(t,e,i){this._resources?(this._width=e,this._height=i):this._initialize(t,e,i)}}function Mi(r,t,e){const i=new H(r,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,width:t,height:e,samplingMode:S.LINEAR});return[i,new $(r,{colorTarget:k.TEXTURE,depthStencilTarget:V.STENCIL_RENDER_BUFFER},i)]}class Gn{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(t,e,i){this._width=e,this._height=i;const[s,n]=Mi(t,e,i),[a,o]=Mi(t,e,i);this._resources={sharedBlur1Tex:s,sharedBlur1Fbo:n,sharedBlur2Tex:a,sharedBlur2Fbo:o}}setup(t,e,i){!this._resources||this._width===e&&this._height===i||this.dispose(),this._resources||this._initialize(t,e,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}const Ot=4,ue=4/Ot;class kn extends ne{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new $n,this._hlGradient=new Nn,this._width=void 0,this._height=void 0,this._hlSurfaces=new Gn,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new is}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(t){const{context:e,painter:i}=t,{width:s,height:n}=e.getViewport(),a=i.getFbos(s,n).effect0;this.setup(t,s,n),e.bindFramebuffer(a),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:t},e,i){this._width=e,this._height=i;const s=e%Ot,n=i%Ot;e+=s<Ot/2?-s:Ot-s,i+=n<Ot/2?-n:Ot-n,this._adjustedWidth=e,this._adjustedHeight=i,this._boundFBO=t.getBoundFramebufferObject();const a=Math.round(e*ue),o=Math.round(i*ue);this._hlRenderer.setup(t,a,o),this._hlSurfaces.setup(t,a,o)}draw({context:t}){const e=t.getBoundFramebufferObject();t.setViewport(0,0,this._adjustedWidth*ue,this._adjustedHeight*ue),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,e.colorTexture,S.NEAREST,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(t){this._hlGradient.setHighlightOptions(t)}}class Vn extends ne{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){D(this._fbo)&&this._fbo.dispose()}createOptions({pixelRatio:t},e,i=es){if(!e.length)return null;const s=e.shift(),n=s.point.x,a=s.point.y;return this._outstanding=s,{type:"hittest",distance:i*t,position:[n,a]}}bind(t){const{context:e,attributeView:i}=t;if(!i.size)return;const s=i.getBlock(ai);if(N(s))return;const n=s.getFBO(e);e.setViewport(0,0,i.size,i.size),e.bindFramebuffer(n),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT)}unbind(t){}draw(t){const{context:e,attributeView:i}=t,s=i.getBlock(ai);if(N(this._outstanding))return;const n=this._outstanding.resolver;if(N(s))return n.resolve([]),void(this._outstanding=null);const a=s.getFBO(e),o=new Uint8Array(a.width*a.height*4);a.readPixels(0,0,a.width,a.height,y.RGBA,O.UNSIGNED_BYTE,o);const h=[];for(let l=0;l<o.length;l+=4)o[l]&&h.push(l/4);this._outstanding=null,n.resolve(h)}}class Wn extends ne{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){D(this._fbo)&&this._fbo.dispose()}bind({context:t,painter:e}){const{width:i,height:s}=t.getViewport();this._boundFBO=t.getBoundFramebufferObject();const n=e.getFbos(i,s).effect0;t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind({context:t}){t.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw({context:t,state:e,pixelRatio:i},s,n=2*es){const a=t.getBoundFramebufferObject(),o=e.size[1]*i,h=Math.round(n*i),l=h/2,d=h/2;this._ensureBuffer(h),s.forEach((c,_)=>{const f=new Map,p=Math.floor(_.x*i-h/2),u=Math.floor(o-_.y*i-h/2);a.readPixels(p,u,h,h,y.RGBA,O.UNSIGNED_BYTE,this._buf);for(let E=0;E<this._buf32.length;E++){const g=this._buf32[E];if(g!==4294967295&&g!==0){const T=E%h,b=h-Math.floor(E/h),w=(l-T)*(l-T)+(d-b)*(d-b),v=f.has(g)?f.get(g):4294967295;f.set(g,Math.min(w,v))}}const m=Array.from(f).sort((E,g)=>E[1]-g[1]).map(E=>E[0]);c.resolve(m),s.delete(_)})}_ensureBuffer(t){this._lastSize!==t&&(this._lastSize=t,this._buf=new Uint8Array(4*t*t),this._buf32=new Uint32Array(this._buf.buffer))}}const Ae=5,Xn=[1,0],Hn=[0,1],qn=[1,.8,.6,.4,.2],Yn=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class jn{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(Ae),this._nMips=Ae,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let t=0;t<this._nMips;t++)this._mipsFBOs[t]&&(this._mipsFBOs[t].horizontal.dispose(),this._mipsFBOs[t].vertical.dispose());this._mipsFBOs=null}}draw(t,e,i){const{width:s,height:n}=e,{context:a,painter:o}=t,{materialManager:h}=o,l=a.gl,d=this._programDesc,{strength:c,radius:_,threshold:f}=i;this._quad||(this._quad=new Vt(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(t,s,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),a.setStencilWriteMask(0);const p=this._quad;p.bind(),a.bindFramebuffer(this._intensityFBO);const u=h.getProgram(t,d.luminosityHighPass);a.useProgram(u),a.bindTexture(e.colorTexture,0),u.setUniform1i("u_texture",0),u.setUniform3fv("u_defaultColor",[0,0,0]),u.setUniform1f("u_defaultOpacity",0),u.setUniform1f("u_luminosityThreshold",f),u.setUniform1f("u_smoothWidth",.01);const m=[Math.round(s/2),Math.round(n/2)];a.setViewport(0,0,m[0],m[1]),a.setClearColor(0,0,0,0),a.clear(l.COLOR_BUFFER_BIT),p.draw(),a.setBlendingEnabled(!1);let E=this._intensityFBO.colorTexture;for(let b=0;b<this._nMips;b++){const w=h.getProgram(t,d.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[b]}]);a.useProgram(w),a.bindTexture(E,b+1),w.setUniform1i("u_colorTexture",b+1),w.setUniform2fv("u_texSize",m),w.setUniform2fv("u_direction",Xn),a.setViewport(0,0,m[0],m[1]);const v=this._mipsFBOs[b];a.bindFramebuffer(v.horizontal),p.draw(),E=v.horizontal.colorTexture,a.bindFramebuffer(v.vertical),a.bindTexture(E,b+1),w.setUniform2fv("u_direction",Hn),p.draw(),E=v.vertical.colorTexture,m[0]=Math.round(m[0]/2),m[1]=Math.round(m[1]/2)}a.setViewport(0,0,s,n);const g=h.getProgram(t,d.composite,[{name:"nummips",value:Ae}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(g),g.setUniform1f("u_bloomStrength",c),g.setUniform1f("u_bloomRadius",_),g.setUniform1fv("u_bloomFactors",qn),g.setUniform3fv("u_bloomTintColors",Yn),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),g.setUniform1i("u_blurTexture1",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),g.setUniform1i("u_blurTexture2",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),g.setUniform1i("u_blurTexture3",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),g.setUniform1i("u_blurTexture4",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),g.setUniform1i("u_blurTexture5",5),p.draw(),a.bindFramebuffer(e),a.setBlendingEnabled(!0);const T=h.getProgram(t,d.blit);a.useProgram(T),a.bindTexture(this._compositeFBO.colorTexture,6),T.setUniform1i("u_texture",6),a.setBlendFunction(R.ONE,R.ONE),p.draw(),p.unbind(),a.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}_createOrResizeResources(t,e,i){const{context:s}=t;if(this._compositeFBO&&this._size[0]===e&&this._size[1]===i)return;this._size[0]=e,this._size[1]=i;const n=[Math.round(e/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(e,i):this._compositeFBO=new $(s,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE,width:e,height:i}),this._intensityFBO?this._intensityFBO.resize(n[0],n[1]):this._intensityFBO=new $(s,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE,width:n[0],height:n[1]},{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:n[0],height:n[1]});for(let a=0;a<this._nMips;a++)this._mipsFBOs[a]?(this._mipsFBOs[a].horizontal.resize(n[0],n[1]),this._mipsFBOs[a].vertical.resize(n[0],n[1])):this._mipsFBOs[a]={horizontal:new $(s,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE,width:n[0],height:n[1]},{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:n[0],height:n[1]}),vertical:new $(s,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE,width:n[0],height:n[1]},{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:n[0],height:n[1]})},n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}const Kn=[1,0],Zn=[0,1];class Qn{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(t,e,i){const{context:s}=t,{type:n,radius:a}=i;if(a===0)return;this._createOrResizeResources(t),this._quad||(this._quad=new Vt(s,[-1,-1,1,-1,-1,1,1,1]));const o=this._quad;o.bind(),n==="blur"?this._gaussianBlur(t,e,a):this._radialBlur(t,e),o.unbind()}_gaussianBlur(t,e,i){const{context:s,state:n,painter:a,pixelRatio:o}=t,{size:h}=n,{materialManager:l}=a,d=this._programDesc,c=this._quad,_=[Math.round(o*h[0]),Math.round(o*h[1])],f=this._blurFBO,p=l.getProgram(t,d.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);s.useProgram(p),s.setBlendingEnabled(!1),s.bindFramebuffer(f),s.bindTexture(e.colorTexture,4),p.setUniform1i("u_colorTexture",4),p.setUniform2fv("u_texSize",_),p.setUniform2fv("u_direction",Kn),p.setUniform1f("u_sigma",i),c.draw(),s.bindFramebuffer(e),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.bindTexture(f.colorTexture,5),p.setUniform1i("u_colorTexture",5),p.setUniform2fv("u_direction",Zn),c.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}_radialBlur(t,e){const{context:i,painter:s}=t,{materialManager:n}=s,a=this._programDesc,o=this._quad,h=this._blurFBO;i.bindFramebuffer(h);const l=n.getProgram(t,a.radialBlur);i.useProgram(l),i.setBlendingEnabled(!1),i.bindTexture(e.colorTexture,4),l.setUniform1i("u_colorTexture",4),o.draw(),i.bindFramebuffer(e),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const d=n.getProgram(t,a.blit);i.useProgram(d),i.bindTexture(h.colorTexture,5),d.setUniform1i("u_texture",5),i.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),o.draw()}_createOrResizeResources(t){const{context:e,state:i,pixelRatio:s}=t,{size:n}=i,a=Math.round(s*n[0]),o=Math.round(s*n[1]);this._blurFBO&&this._size[0]===a&&this._size[1]===o||(this._size[0]=a,this._size[1]=o,this._blurFBO?this._blurFBO.resize(a,o):this._blurFBO=new $(e,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE,width:a,height:o},{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:a,height:o}))}}class Jn{constructor(){this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(t,e,i){const{width:s,height:n}=e;this._createOrResizeResources(t,s,n);const{context:a,painter:o}=t,{materialManager:h}=o,l=this._programDesc,d=this._quad,c=i.colorMatrix;d.bind();const _=this._layerFBOTexture;a.bindFramebuffer(e),e.copyToTexture(0,0,s,n,0,0,_),a.setBlendingEnabled(!1),a.setStencilTestEnabled(!1);const f=h.getProgram(t,l);a.useProgram(f),a.bindTexture(_,2),f.setUniformMatrix4fv("u_coefficients",c),f.setUniform1i("u_colorTexture",2),d.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0),d.unbind()}_createOrResizeResources(t,e,i){const{context:s}=t;this._layerFBOTexture&&this._size[0]===e&&this._size[1]===i||(this._size[0]=e,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(e,i):this._layerFBOTexture=new H(s,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:e,height:i}),this._quad||(this._quad=new Vt(s,[-1,-1,1,-1,-1,1,1,1])))}}const ta=[1,0],ea=[0,1];class ia{constructor(){this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}draw(t,e,i){const{context:s,state:n,painter:a}=t,{materialManager:o}=a,h=this._programDesc,l=e.width,d=e.height,c=[Math.round(l/2),Math.round(d/2)],{blurRadius:_,offsetX:f,offsetY:p,color:u}=i,m=[yt(f/2),yt(p/2)];this._createOrResizeResources(t,l,d,c);const E=this._horizontalBlurFBO,g=this._verticalBlurFBO;s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1);const T=this._layerFBOTexture;e.copyToTexture(0,0,l,d,0,0,T),this._quad||(this._quad=new Vt(s,[-1,-1,1,-1,-1,1,1,1])),s.setViewport(0,0,c[0],c[1]);const b=this._quad;b.bind(),s.setBlendingEnabled(!1);const w=o.getProgram(t,h.blur,[{name:"radius",value:Math.ceil(_)}]);s.useProgram(w),s.bindFramebuffer(E),s.bindTexture(e.colorTexture,4),w.setUniform1i("u_colorTexture",4),w.setUniform2fv("u_texSize",c),w.setUniform2fv("u_direction",ta),w.setUniform1f("u_sigma",_),b.draw(),s.bindFramebuffer(g),s.bindTexture(E.colorTexture,5),w.setUniform1i("u_colorTexture",5),w.setUniform2fv("u_direction",ea),b.draw(),s.bindFramebuffer(e),s.setViewport(0,0,l,d);const v=o.getProgram(t,h.composite);s.useProgram(v),s.bindTexture(g.colorTexture,2),v.setUniform1i("u_blurTexture",2),s.bindTexture(T,3),v.setUniform1i("u_layerFBOTexture",3),v.setUniform4fv("u_shadowColor",[u[3]*(u[0]/255),u[3]*(u[1]/255),u[3]*(u[2]/255),u[3]]),v.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),v.setUniform2fv("u_shadowOffset",m),b.draw(),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!0),s.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),b.unbind()}_createOrResizeResources(t,e,i,s){const{context:n}=t;this._horizontalBlurFBO&&this._size[0]===e&&this._size[1]===i||(this._size[0]=e,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(s[0],s[1]):this._horizontalBlurFBO=new $(n,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE,width:s[0],height:s[1]},{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:s[0],height:s[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(s[0],s[1]):this._verticalBlurFBO=new $(n,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE,width:s[0],height:s[1]},{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:s[0],height:s[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(e,i):this._layerFBOTexture=new H(n,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:e,height:i}))}}class sa{constructor(){this._size=[0,0]}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(t,e,i){const{width:s,height:n}=e;this._createOrResizeResources(t,s,n);const{context:a,painter:o}=t,{amount:h}=i,l=a.gl,d=this._layerFBOTexture;a.bindFramebuffer(e),e.copyToTexture(0,0,s,n,0,0,d),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!1),a.setDepthTestEnabled(!1),a.setClearColor(0,0,0,0),a.clear(l.COLOR_BUFFER_BIT),o.blitTexture(a,d,S.NEAREST,h)}_createOrResizeResources(t,e,i){const{context:s}=t;this._layerFBOTexture&&this._size[0]===e&&this._size[1]===i||(this._size[0]=e,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(e,i):this._layerFBOTexture=new H(s,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.NEAREST,flipped:!1,width:e,height:i}))}}function ra(r){switch(r){case"bloom":case"blur":case"opacity":case"drop-shadow":return r;default:return"colorize"}}const na={colorize:()=>new Jn,blur:()=>new Qn,bloom:()=>new jn,opacity:()=>new sa,"drop-shadow":()=>new ia};class aa{constructor(t){this._requestRender=t,this._effectMap=new Map}dispose(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach(t=>t.dispose()),this._effectMap.clear()}getPostProcessingEffects(t){if(!t||t.length===0)return[];const e=[];for(const i of t){const s=ra(i.type);let n=this._effectMap.get(s);n||(n=na[s](),this._effectMap.set(s,n)),e.push({postProcessingEffect:n,effect:i})}return e}}class oa{constructor(t,e){var i;this.brushes=t,this.name=e.name,this.drawPhase=e.drawPhase||Q.MAP,this._targetFn=e.target,this.effects=e.effects||[],this.enableDefaultDraw=(i=e.enableDefaultDraw)!=null?i:()=>!0}render(t){const{context:e,profiler:i}=t,s=this._targetFn(),n=this.drawPhase&t.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(t,s),i.recordPassEnd();for(const a of this.effects){if(!a.enable())continue;const o=a.apply;i.recordPassStart(this.name+"."+o.name),i.recordBrushStart(o.name);const h=a.args&&a.args(),{x:l,y:d,width:c,height:_}=e.getViewport(),f=e.getBoundFramebufferObject();o.bind(t,h);const p=o.createOptions(t,h),u=t.passOptions;t.passOptions=p,this._doRender(t,s,o.defines),t.passOptions=u,o.draw(t,h),o.unbind(t,h),e.bindFramebuffer(f),e.setViewport(l,d,c,_),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(t,e,i){if(!N(e))if(Ms(e)){for(const s of e)if(s.visible)for(const n of this.brushes)t.profiler.recordBrushStart(n.name),n.prepareState(t,s,i),n.draw(t,s,i),t.profiler.recordBrushEnd()}else for(const s of this.brushes)t.profiler.recordBrushStart(s.name),s.prepareState(t,e,i),s.draw(t,e,i),t.profiler.recordBrushEnd()}}const la={[he.FILL]:Lt.fill,[he.LINE]:Lt.line,[he.MARKER]:Lt.marker,[he.TEXT]:Lt.text};class ha{constructor(t,e,i){this.context=t,this._blitRenderer=new is,this._brushCache=new Map,this._vtlMaterialManager=new Jr,this._blendEffect=new Mn,this._fboPool=[],this.effects={highlight:new kn,hittest:new Vn,hittestVTL:new Wn,integrate:new On,insideEffect:new Ci("inside"),outsideEffect:new Ci("outside")},this.materialManager=new nn(t),this.textureManager=new Sn(e,i),this._effectsManager=new aa(e)}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(t){this._renderTarget=t}getFbos(t,e){if(t!==this._lastWidth||e!==this._lastHeight){if(this._lastWidth=t,this._lastHeight=e,this._fbos){for(const a in this._fbos)this._fbos[a].resize(t,e);return this._fbos}const i={target:I.TEXTURE_2D,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,samplingMode:S.NEAREST,wrapMode:U.CLAMP_TO_EDGE,width:t,height:e},s={colorTarget:k.TEXTURE,depthStencilTarget:V.DEPTH_STENCIL_RENDER_BUFFER},n=new Rr(this.context,{width:t,height:e,internalFormat:Br.DEPTH_STENCIL});this._stencilBuf=n,this._fbos={output:new $(this.context,s,i,n),blend:new $(this.context,s,i,n),effect0:new $(this.context,s,i,n)}}return this._fbos}acquireFbo(t,e){let i;i=this._fboPool.length>0?this._fboPool.pop():new $(this.context,{colorTarget:k.TEXTURE,depthStencilTarget:V.DEPTH_STENCIL_RENDER_BUFFER},{target:I.TEXTURE_2D,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,samplingMode:S.NEAREST,wrapMode:U.CLAMP_TO_EDGE,width:t,height:e},this._stencilBuf);const s=i.descriptor;return s.width===t&&s.height===e||i.resize(t,e),i}releaseFbo(t){this._fboPool.push(t)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(t,e=null){const{width:i,height:s}=t.getViewport();this._prevFBO=t.getBoundFramebufferObject();const n=this.getFbos(i,s);if(t.bindFramebuffer(n.output),t.setColorMask(!0,!0,!0,!0),t.setDepthWriteEnabled(!0),D(e)){const{r:a,g:o,b:h,a:l}=e.color;t.setClearColor(l*a/255,l*o/255,l*h/255,l)}else t.setClearColor(0,0,0,0);t.setClearDepth(1),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT),t.setDepthWriteEnabled(!1)}beforeRenderLayer(t,e,i){const{context:s,blendMode:n,effects:a,requireFBO:o,drawPhase:h}=t;if(o||Pi(h,n,a,i))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1);else{const l=this._getOutputFBO();s.bindFramebuffer(l)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(e),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}compositeLayer(t,e){const{context:i,blendMode:s,effects:n,requireFBO:a,drawPhase:o}=t;if(a||Pi(o,s,n,e)){D(n)&&n.length>0&&o===Q.MAP&&this._applyEffects(t,n);const h=this._getOutputFBO();i.bindFramebuffer(h),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(R.ONE,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);const l=N(s)||o===Q.HIGHLIGHT?"normal":s;this._blendEffect.draw(t,this._fbos.blend.colorTexture,S.NEAREST,l,e)}}renderLayers(t){if(t.bindFramebuffer(this._prevFBO),!this._fbos)return;const e=this._getOutputFBO();t.setStencilTestEnabled(!1),t.setStencilWriteMask(0),this.blitTexture(t,e.colorTexture,S.NEAREST)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach(t=>t.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const t in this._fbos)this._fbos[t]&&this._fbos[t].dispose();for(const t of this._fboPool)t.dispose();if(this._fboPool.length=0,this.effects)for(const t in this.effects)this.effects[t]&&this.effects[t].dispose();this._effectsManager.dispose(),this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}getGeometryBrush(t){const e=la[t];let i=this._brushCache.get(e);return i===void 0&&(i=new e,this._brushCache.set(e,i)),this._brushCache.get(e)}renderObject(t,e,i,s){const n=Lt[i];if(!n)return null;let a=this._brushCache.get(n);a===void 0&&(a=new n,this._brushCache.set(n,a)),a.prepareState(t,e,s),a.draw(t,e,s)}renderObjects(t,e,i,s){const n=Lt[i];if(!n)return null;let a=this._brushCache.get(n);a===void 0&&(a=new n,this._brushCache.set(n,a)),a.drawMany(t,e,s)}registerRenderPass(t){const e=t.brushes.map(i=>(this._brushCache.has(i)||this._brushCache.set(i,new i),this._brushCache.get(i)));return new oa(e,t)}setHighlightOptions(t){this.effects.highlight.setHighlightOptions(t)}blitTexture(t,e,i,s=1){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(R.ONE,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(t,e,i,s)}getPostProcessingEffects(t){return this._effectsManager.getPostProcessingEffects(t)}_getOutputFBO(){return this._renderTarget!=null?this._renderTarget:this._fbos.output}_applyEffects(t,e){const{context:i}=t,s=this._effectsManager.getPostProcessingEffects(e);for(const{postProcessingEffect:n,effect:a}of s)i.bindFramebuffer(this._fbos.blend),n.draw(t,this._fbos.blend,a)}}function Pi(r,t,e,i){return r!==Q.HIGHLIGHT&&(i!==1||D(t)&&t!=="normal"||D(e)&&e.length>0)}class Di{constructor(t,e,i,s,n,a,o,h){this.createQuery=t,this.resultAvailable=e,this.getResult=i,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=a,this.createTimestamp=o,this.timestampBits=h}}function ls(r,t){if(t.disjointTimerQuery)return null;let e=r.getExtension("EXT_disjoint_timer_query_webgl2");return e&&W(r)?new Di(()=>r.createQuery(),i=>r.getQueryParameter(i,r.QUERY_RESULT_AVAILABLE),i=>r.getQueryParameter(i,r.QUERY_RESULT),()=>r.getParameter(e.GPU_DISJOINT_EXT),i=>r.beginQuery(e.TIME_ELAPSED_EXT,i),()=>r.endQuery(e.TIME_ELAPSED_EXT),i=>e.queryCounterEXT(i,e.TIMESTAMP_EXT),()=>r.getQuery(e.TIMESTAMP_EXT,e.QUERY_COUNTER_BITS_EXT)):(e=r.getExtension("EXT_disjoint_timer_query"),e?new Di(()=>e.createQueryEXT(),i=>e.getQueryObjectEXT(i,e.QUERY_RESULT_AVAILABLE_EXT),i=>e.getQueryObjectEXT(i,e.QUERY_RESULT_EXT),()=>r.getParameter(e.GPU_DISJOINT_EXT),i=>e.beginQueryEXT(e.TIME_ELAPSED_EXT,i),()=>e.endQueryEXT(e.TIME_ELAPSED_EXT),i=>e.queryCounterEXT(i,e.TIMESTAMP_EXT),()=>e.getQueryEXT(e.TIMESTAMP_EXT,e.QUERY_COUNTER_BITS_EXT)):null)}const nt=ge("esri-2d-profiler");class ua{constructor(t,e){if(this._events=new Ps,this._entries=new Map,this._timings=new Lr(10),!nt)return;this._ext=ls(t.gl,{}),this._debugOutput=e;const i=t.gl;if(this.enableCommandLogging){for(const s in i)if(typeof i[s]=="function"){const n=i[s],a=s.indexOf("draw")!==-1;i[s]=(...o)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:s,args:o,isDrawCommand:a}),this._currentSummary&&(this._currentSummary.commands++,a&&this._currentSummary.drawCommands++),n.apply(i,o))}}}get enableCommandLogging(){return!(typeof nt=="object"&&nt.disableCommands)}recordContainerStart(t){nt&&(this._currentContainer=t)}recordContainerEnd(){nt&&(this._currentContainer=null)}recordPassStart(t){nt&&(this._currentPass=t,this._initSummary())}recordPassEnd(){nt&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){nt&&(this._currentBrush=t)}recordBrushEnd(){nt&&(this._currentBrush=null)}recordStart(t){if(nt&&D(this._ext)){if(this._entries.has(t)){const i=this._entries.get(t),s=this._ext.resultAvailable(i.query),n=this._ext.disjoint();if(s&&!n){const a=this._ext.getResult(i.query)/1e6;let o=0;if(D(this._timings.enqueue(a))){const d=this._timings.entries,c=d.length;let _=0;for(const f of d)_+=f;o=_/c}const h=a.toFixed(2),l=o?o.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${h} ms (${l} last 10 avg)
${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${h} ms (${l} last 10 avg)`),this._debugOutput.innerHTML=`${h} (${l})`}for(const a of i.handles)a.remove();this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",i=>{e.commandsLen++,e.commands.push(i),i.isDrawCommand&&e.drawCommands++})),e.handles.push(this._events.on("summary",i=>{e.summaries.push(i)}))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){nt&&D(this._ext)&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}const Ii={shaders:{vertexShader:J("stencil/stencil.vert"),fragmentShader:J("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])};class Ui{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:R.ONE,dstRGB:R.ZERO,srcAlpha:R.ONE,dstAlpha:R.ZERO},this.blendEquation={mode:Ue.ADD,modeAlpha:Ue.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=Mt.BACK,this.frontFace=Ji.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=zt.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:Mt.FRONT_AND_BACK,func:zt.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:Mt.FRONT_AND_BACK,fail:mt.KEEP,zFail:mt.KEEP,zPass:mt.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array}}class da{constructor(t){this._allocations=new Map,t?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(t){this._allocations.set(t,new Error().stack)}remove(t){this._allocations.delete(t)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const t=new Map;this._allocations.forEach(e=>{var i;t.set(e,((i=t.get(e))!=null?i:0)+1)}),t.forEach((e,i)=>{const s=i.split(`
`);s.shift(),s.shift(),console.log(`${e}: ${s.shift()}`),s.forEach(n=>console.log("   ",n))})}}}class ca{constructor(){this.RECORD_ALLOCATIONS=!1}}const _a=new ca;class fa{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new da(_a.RECORD_ALLOCATIONS);this._current.length<Qt.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(t,e){const i=++this._current[t];this._max[t]=Math.max(i,this._max[t]),this._allocations.add(e)}decrement(t,e){--this._current[t],this._allocations.remove(e)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((t,e)=>t+e,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let t=0;t<Qt.COUNT;++t){const e=this._current[t];e>0&&console.log(`${Qt[t]}: ${e}`)}}this._allocations.print()}}function Ni(r,t){const e=new $(r,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1});function i(E,g){const T=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${t?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,b=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `,w=r.programCache.acquire(T,b,new Map([["position",0]])),v=new Float32Array(6);li(E,v,3);const B=new Float32Array(6);return li(g,B,3),r.useProgram(w),w.setUniform3f("u_highA",v[0],v[2],v[4]),w.setUniform3f("u_lowA",v[1],v[3],v[5]),w.setUniform3f("u_highB",B[0],B[2],B[4]),w.setUniform3f("u_lowB",B[1],B[3],B[5]),w}const s=gt.createVertex(r,bt.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new Bt(r,new Map([["position",0]]),{geometry:[new $t("position",2,Pt.UNSIGNED_SHORT,0,4)]},{geometry:s}),a=De(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),o=De(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),h=i(a,o),l=r.getBoundFramebufferObject(),{x:d,y:c,width:_,height:f}=r.getViewport();r.bindFramebuffer(e),r.setViewport(0,0,1,1),r.bindVAO(n),r.drawArrays(X.TRIANGLE_STRIP,0,4);const p=new Uint8Array(4);e.readPixels(0,0,1,1,y.RGBA,O.UNSIGNED_BYTE,p),h.dispose(),n.dispose(!1),s.dispose(),e.dispose(),r.setViewport(d,c,_,f),r.bindFramebuffer(l);const u=(a[2]-o[2])/25,m=_r(p);return Math.abs(u-m)}var Li,zi,$i,hs={exports:{}};function pa(r){var t,e,i,s,n;if(!r.gl)return!1;if(r.type===me.WEBGL1)return!((s=r.capabilities.textureFloat)==null||!s.textureFloat||(n=r.capabilities.colorBufferFloat)==null||!n.textureFloat);if(!(((t=r.capabilities.textureFloat)==null?void 0:t.textureFloat)&&((e=r.capabilities.colorBufferFloat)==null?void 0:e.textureFloat)&&((i=r.capabilities.colorBufferFloat)==null?void 0:i.floatBlend)))return!1;const a=new $(r,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:y.RGBA,dataType:O.FLOAT,internalFormat:Ar.RGBA32F,samplingMode:S.NEAREST,width:1,height:1}),o=gt.createVertex(r,bt.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),h=new Bt(r,new Map([["a_pos",0]]),{geometry:[new $t("a_pos",2,Pt.UNSIGNED_SHORT,0,4)]},{geometry:o}),l=`
  precision highp float;
  attribute vec2 a_pos;

  void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,d=`
   precision highp float;

   void main() {
    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
   }
  `,c=r.programCache.acquire(l,d,new Map([["a_pos",0]]));r.useProgram(c);const _=r.getBoundFramebufferObject(),{x:f,y:p,width:u,height:m}=r.getViewport();r.bindFramebuffer(a),r.setViewport(0,0,1,1),r.bindVAO(h),r.drawArrays(X.TRIANGLE_STRIP,0,4);const E=zr({blending:$r});r.setPipelineState(E),r.drawArrays(X.TRIANGLE_STRIP,0,4),hs.exports.init(r);const g=r.gl.getError();return r.setViewport(f,p,u,m),r.bindFramebuffer(_),c.dispose(),h.dispose(!1),o.dispose(),a.dispose(),g!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}Li=hs,zi=function(){var r=function(u){window.console&&window.console.log&&window.console.log(u)},t=function(u){window.console&&window.console.error?window.console.error(u):r(u)},e={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},i=null,s=null;function n(u){if(i==null)for(var m in i={},s={},u)typeof u[m]=="number"&&(i[u[m]]=m,s[m]=u[m])}function a(){if(i==null)throw"WebGLDebugUtils.init(ctx) not called"}function o(u){return a(),i[u]!==void 0}function h(u){a();var m=i[u];return m!==void 0?"gl."+m:"/*UNKNOWN WebGL ENUM*/ 0x"+u.toString(16)}function l(u,m,E,g){var T;if((T=e[u])!==void 0&&(T=T[m])!==void 0&&T[E]){if(typeof T[E]=="object"&&T[E].enumBitwiseOr!==void 0){for(var b=T[E].enumBitwiseOr,w=0,v=[],B=0;B<b.length;++B){var A=s[b[B]];(g&A)!=0&&(w|=A,v.push(h(A)))}return w===g?v.join(" | "):h(g)}return h(g)}return g===null?"null":g===void 0?"undefined":g.toString()}function d(u,m){for(var E="",g=m.length,T=0;T<g;++T)E+=(T==0?"":", ")+l(u,g,T,m[T]);return E}function c(u,m,E){u.__defineGetter__(E,function(){return m[E]}),u.__defineSetter__(E,function(g){m[E]=g})}function _(u,m,E,g){g=g||u,n(u),m=m||function(A,M,st){for(var ot="",lt=st.length,vt=0;vt<lt;++vt)ot+=(vt==0?"":", ")+l(M,lt,vt,st[vt]);t("WebGL error "+h(A)+" in "+M+"("+ot+")")};var T={};function b(A,M){return function(){E&&E(M,arguments);var st=A[M].apply(A,arguments),ot=g.getError();return ot!=0&&(T[ot]=!0,m(ot,M,arguments)),st}}var w={};for(var v in u)if(typeof u[v]=="function")if(v!="getExtension")w[v]=b(u,v);else{var B=b(u,v);w[v]=function(){return _(B.apply(u,arguments),m,E,g)}}else c(w,u,v);return w.getError=function(){for(var A in T)if(T.hasOwnProperty(A)&&T[A])return T[A]=!1,A;return u.NO_ERROR},w}function f(u){var m=u.getParameter(u.MAX_VERTEX_ATTRIBS),E=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,E);for(var g=0;g<m;++g)u.disableVertexAttribArray(g),u.vertexAttribPointer(g,4,u.FLOAT,!1,0,0),u.vertexAttrib1f(g,0);u.deleteBuffer(E);var T=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS);for(g=0;g<T;++g)u.activeTexture(u.TEXTURE0+g),u.bindTexture(u.TEXTURE_CUBE_MAP,null),u.bindTexture(u.TEXTURE_2D,null);for(u.activeTexture(u.TEXTURE0),u.useProgram(null),u.bindBuffer(u.ARRAY_BUFFER,null),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,null),u.bindFramebuffer(u.FRAMEBUFFER,null),u.bindRenderbuffer(u.RENDERBUFFER,null),u.disable(u.BLEND),u.disable(u.CULL_FACE),u.disable(u.DEPTH_TEST),u.disable(u.DITHER),u.disable(u.SCISSOR_TEST),u.blendColor(0,0,0,0),u.blendEquation(u.FUNC_ADD),u.blendFunc(u.ONE,u.ZERO),u.clearColor(0,0,0,0),u.clearDepth(1),u.clearStencil(-1),u.colorMask(!0,!0,!0,!0),u.cullFace(u.BACK),u.depthFunc(u.LESS),u.depthMask(!0),u.depthRange(0,1),u.frontFace(u.CCW),u.hint(u.GENERATE_MIPMAP_HINT,u.DONT_CARE),u.lineWidth(1),u.pixelStorei(u.PACK_ALIGNMENT,4),u.pixelStorei(u.UNPACK_ALIGNMENT,4),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),u.UNPACK_COLORSPACE_CONVERSION_WEBGL&&u.pixelStorei(u.UNPACK_COLORSPACE_CONVERSION_WEBGL,u.BROWSER_DEFAULT_WEBGL),u.polygonOffset(0,0),u.sampleCoverage(1,!1),u.scissor(0,0,u.canvas.width,u.canvas.height),u.stencilFunc(u.ALWAYS,0,4294967295),u.stencilMask(4294967295),u.stencilOp(u.KEEP,u.KEEP,u.KEEP),u.viewport(0,0,u.canvas.width,u.canvas.height),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT|u.STENCIL_BUFFER_BIT);u.getError(););}function p(u){var m,E,g=[],T=[],b={},w=1,v=!1,B=[],A=0,M=0,st=!1,ot=0,lt={};function vt(x){return typeof x=="function"?x:function(C){x.handleEvent(C)}}u.getContext=(E=u.getContext,function(){var x=E.apply(u,arguments);if(x instanceof WebGLRenderingContext){if(x!=m){if(m)throw"got different context";b=vs(m=x)}return b}return x});var _s=function(x){g.push(vt(x))},fs=function(x){T.push(vt(x))};function ps(x){var C=x.addEventListener;x.addEventListener=function(q,Y,dt){switch(q){case"webglcontextlost":_s(Y);break;case"webglcontextrestored":fs(Y);break;default:C.apply(x,arguments)}}}function ms(){for(var x=Object.keys(lt),C=0;C<x.length;++C)delete lt[x]}function Et(){++M,v||A==M&&u.loseContext()}function gs(x,C){var q=x[C];return function(){if(Et(),!v)return q.apply(x,arguments)}}function bs(){for(var x=0;x<B.length;++x){var C=B[x];C instanceof WebGLBuffer?m.deleteBuffer(C):C instanceof WebGLFramebuffer?m.deleteFramebuffer(C):C instanceof WebGLProgram?m.deleteProgram(C):C instanceof WebGLRenderbuffer?m.deleteRenderbuffer(C):C instanceof WebGLShader?m.deleteShader(C):C instanceof WebGLTexture&&m.deleteTexture(C)}}function Xe(x){return{statusMessage:x,preventDefault:function(){st=!0}}}return ps(u),u.loseContext=function(){if(!v){for(v=!0,A=0,++w;m.getError(););ms(),lt[m.CONTEXT_LOST_WEBGL]=!0;var x=Xe("context lost"),C=g.slice();setTimeout(function(){for(var q=0;q<C.length;++q)C[q](x);ot>=0&&setTimeout(function(){u.restoreContext()},ot)},0)}},u.restoreContext=function(){v&&T.length&&setTimeout(function(){if(!st)throw"can not restore. webglcontestlost listener did not call event.preventDefault";bs(),f(m),v=!1,M=0,st=!1;for(var x=T.slice(),C=Xe("context restored"),q=0;q<x.length;++q)x[q](C)},0)},u.loseContextInNCalls=function(x){if(v)throw"You can not ask a lost contet to be lost";A=M+x},u.getNumCalls=function(){return M},u.setRestoreTimeout=function(x){ot=x},u;function vs(x){for(var C in x)typeof x[C]=="function"?b[C]=gs(x,C):c(b,x,C);b.getError=function(){if(Et(),!v)for(;G=m.getError();)lt[G]=!0;for(var G in lt)if(lt[G])return delete lt[G],G;return b.NO_ERROR};for(var q=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],Y=0;Y<q.length;++Y){var dt=q[Y];b[dt]=function(G){return function(){if(Et(),v)return null;var xe=G.apply(x,arguments);return xe.__webglDebugContextLostId__=w,B.push(xe),xe}}(x[dt])}var He=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(Y=0;Y<He.length;++Y)dt=He[Y],b[dt]=function(G){return function(){return Et(),v?null:G.apply(x,arguments)}}(b[dt]);var qe=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(Y=0;Y<qe.length;++Y)dt=qe[Y],b[dt]=function(G){return function(){return Et(),!v&&G.apply(x,arguments)}}(b[dt]);return b.checkFramebufferStatus=function(G){return function(){return Et(),v?b.FRAMEBUFFER_UNSUPPORTED:G.apply(x,arguments)}}(b.checkFramebufferStatus),b.getAttribLocation=function(G){return function(){return Et(),v?-1:G.apply(x,arguments)}}(b.getAttribLocation),b.getVertexAttribOffset=function(G){return function(){return Et(),v?0:G.apply(x,arguments)}}(b.getVertexAttribOffset),b.isContextLost=function(){return v},b}}return{init:n,mightBeEnum:o,glEnumToString:h,glFunctionArgToString:l,glFunctionArgsToString:d,makeDebugContext:_,makeLostContextSimulatingCanvas:p,resetToInitialState:f}},($i=zi())!==void 0&&(Li.exports=$i);const ma=re.getLogger("esri.views.WebGLDriverTest");function ga(r){const t=new $(r,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1}),e=`
precision highp float;
attribute vec2 a_pos;
uniform highp sampler2D u_texture;
varying vec4 v_color;

float getBit(in float bitset, in int bitIndex) {
  float offset = pow(2.0, float(bitIndex));
  return mod(floor(bitset / offset), 2.0);
}

void main() {
  vec4 value = texture2D(u_texture, vec2(0.0));
  float bit = getBit(value.x * 255.0, 1);

  v_color = bit * vec4(1.0);
  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,i=`
precision highp float;
varying vec4 v_color;

void main() {
  gl_FragColor = v_color;
}
`,s=new Uint8Array(4),n=gt.createVertex(r,bt.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),a=new Bt(r,new Map([["a_position",0]]),{geometry:[new $t("a_position",2,Pt.SHORT,0,4)]},{geometry:n}),o=r.programCache.acquire(e,i,new Map([["a_pos",0]]));r.useProgram(o);const h=new H(r,{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));o.setUniform1i("u_texture",0),r.bindTexture(h,0);const l=r.getBoundFramebufferObject();r.bindFramebuffer(t),r.useProgram(o);const{x:d,y:c,width:_,height:f}=r.getViewport();r.setViewport(0,0,1,1),r.bindVAO(a),r.drawArrays(X.TRIANGLE_STRIP,0,4),r.setViewport(d,c,_,f),t.readPixels(0,0,1,1,y.RGBA,O.UNSIGNED_BYTE,s),o.dispose(),a.dispose(!1),n.dispose(),t.dispose();const p=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return p&&ma.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),r.bindFramebuffer(l),p}async function ba(r){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,await t.decode(),!r.gl)return!0;const e=new $(r,{colorTarget:k.TEXTURE,depthStencilTarget:V.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1}),i=gt.createVertex(r,bt.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),s=new Bt(r,new Map([["a_pos",0]]),Qi,{geometry:i}),n=`
  precision highp float;

  attribute vec2 a_pos;
  varying vec2 v_uv;

  void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,a=`
  precision highp float;

  varying vec2 v_uv;
  uniform sampler2D u_texture;

  void main() {
    gl_FragColor = texture2D(u_texture, v_uv);
  }
  `,o=r.programCache.acquire(n,a,new Map([["a_pos",0]]));r.useProgram(o);const h=new H(r,{dataType:O.UNSIGNED_BYTE,pixelFormat:y.RGBA,preMultiplyAlpha:!1,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR},t);r.bindTexture(h,0),o.setUniform1i("u_texture",0);const l=r.getBoundFramebufferObject(),{x:d,y:c,width:_,height:f}=r.getViewport();r.bindFramebuffer(e),r.setViewport(0,0,1,1),r.setClearColor(0,0,0,0),r.setBlendingEnabled(!1),r.clearSafe(jt.COLOR_BUFFER_BIT),r.bindVAO(s),r.drawArrays(X.TRIANGLE_STRIP,0,4);const p=new Uint8Array(4);return e.readPixels(0,0,1,1,y.RGBA,O.UNSIGNED_BYTE,p),o.dispose(),s.dispose(!1),i.dispose(),e.dispose(),h.dispose(),r.setViewport(d,c,_,f),r.bindFramebuffer(l),t.src="",p[0]===255}class va{constructor(t){this.context=t,this._floatBufferBlendWorking=pa(t),ba(t).then(e=>this._svgAlwaysPremultipliesAlpha=!e)}get floatBufferBlendWorking(){if(N(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(N(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(N(this._doublePrecisionRequiresObfuscation)){const t=Ni(this.context,!1),e=Ni(this.context,!0);this._doublePrecisionRequiresObfuscation=t!==0&&(e===0||t/e>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return N(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=ga(this.context)),this._ignoresSamplerPrecision}}function Ea(r,t){if(t.disjointTimerQuery)return null;if(W(r))return{drawBuffers:r.drawBuffers.bind(r),MAX_DRAW_BUFFERS:r.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:r.MAX_COLOR_ATTACHMENTS};if(t.drawBuffers)return null;const e=r.getExtension("WEBGL_draw_buffers");return e?{drawBuffers:e.drawBuffersWEBGL.bind(e),MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function Ta(r){if(W(r))return{drawArraysInstanced:r.drawArraysInstanced.bind(r),drawElementsInstanced:r.drawElementsInstanced.bind(r),vertexAttribDivisor:r.vertexAttribDivisor.bind(r)};const t=r.getExtension("ANGLE_instanced_arrays");return t?{drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t),vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t)}:null}function xa(r,t){if(t.compressedTextureETC)return null;const e=r.getExtension("WEBGL_compressed_texture_etc");return e?{COMPRESSED_R11_EAC:e.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:e.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:e.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:e.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:e.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:e.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:e.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function wa(r,t){if(t.compressedTextureS3TC)return null;const e=r.getExtension("WEBGL_compressed_texture_s3tc");return e?{COMPRESSED_RGB_S3TC_DXT1:e.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:e.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:e.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:e.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function ya(r,t){if(W(r))return{MIN:r.MIN,MAX:r.MAX};if(t.blendMinMax)return null;{const e=r.getExtension("EXT_blend_minmax");return e?{MIN:e.MIN_EXT,MAX:e.MAX_EXT}:null}}function Fa(r,t){if(t.textureFilterAnisotropic)return null;const e=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return e?{MAX_TEXTURE_MAX_ANISOTROPY:e.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:e.TEXTURE_MAX_ANISOTROPY_EXT}:null}function Ra(r,t){if(W(r))return{textureFloat:!0,textureFloatLinear:!t.textureFloatLinear&&!!r.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!r.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:r.HALF_FLOAT,R16F:r.R16F,RG16F:r.RG16F,RGBA16F:r.RGBA16F,R32F:r.R32F,RG32F:r.RG32F,RGBA32F:r.RGBA32F,R11F_G11F_B10F:r.R11F_G11F_B10F,RGB16F:r.RGB16F};if(r instanceof WebGLRenderingContext){const e=!t.textureHalfFloat&&r.getExtension("OES_texture_half_float");return{textureFloat:!t.textureFloat&&!!r.getExtension("OES_texture_float"),textureFloatLinear:!t.textureFloatLinear&&!!r.getExtension("OES_texture_float_linear"),textureHalfFloat:!!e,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!r.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:e?e.HALF_FLOAT_OES:void 0}}return null}function Ba(r,t){if(W(r)){const e=!t.colorBufferFloat&&r.getExtension("EXT_color_buffer_half_float"),i=!t.colorBufferFloat&&r.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&r.getExtension("EXT_float_blend");return e||i||s?{textureFloat:!!i,textureHalfFloat:!!e,floatBlend:!!s,R16F:r.R16F,RG16F:r.RG16F,RGBA16F:r.RGBA16F,R32F:r.R32F,RG32F:r.RG32F,RGBA32F:r.RGBA32F,R11F_G11F_B10F:r.R11F_G11F_B10F,RGB16F:r.RGB16F}:null}if(r instanceof WebGLRenderingContext){const e=!t.colorBufferFloat&&r.getExtension("EXT_color_buffer_half_float"),i=!t.colorBufferFloat&&r.getExtension("WEBGL_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&r.getExtension("EXT_float_blend");return e||i||s?{textureFloat:!!i,textureHalfFloat:!!e,floatBlend:!!s,RGBA16F:e?e.RGBA16F_EXT:void 0,RGB16F:e?e.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}function de(r,t,e,i,s){if(i&&W(r))return!0;if(t[e])return!1;for(const n of s)if(r.getExtension(n))return!0;return!1}function Aa(r,t){if(!W(r)||t.textureNorm16)return null;const e=r.getExtension("EXT_texture_norm16");return e?{R16:e.R16_EXT,RG16:e.RG16_EXT,RGB16:e.RGB16_EXT,RGBA16:e.RGBA16_EXT,R16_SNORM:e.R16_SNORM_EXT,RG16_SNORM:e.RG16_SNORM_EXT,RGB16_SNORM:e.RGB16_SNORM_EXT,RGBA16_SNORM:e.RGBA16_SNORM_EXT}:null}function Sa(r,t){const e=t.loseContext&&r.getExtension("WEBGL_lose_context");return e?{loseRenderingContext:()=>e.loseContext()}:null}function Oa(r,t){if(W(r))return{createVertexArray:r.createVertexArray.bind(r),deleteVertexArray:r.deleteVertexArray.bind(r),bindVertexArray:r.bindVertexArray.bind(r)};if(t.vao)return null;const e=r.getExtension("OES_vertex_array_object")||r.getExtension("MOZ_OES_vertex_array_object")||r.getExtension("WEBKIT_OES_vertex_array_object");return e?{createVertexArray:e.createVertexArrayOES.bind(e),deleteVertexArray:e.deleteVertexArrayOES.bind(e),bindVertexArray:e.bindVertexArrayOES.bind(e)}:null}class Ca{constructor(t,e){this.gl=t,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._disabledExtensions=e.disabledExtensions||{},this._debugWebGLExtensions=e.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=Ea(this.gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=Ta(this.gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=Oa(this.gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=xa(this.gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=wa(this.gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=Fa(this.gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=ls(this.gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=Ra(this.gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=Ba(this.gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=ya(this.gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=de(this.gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return this._standardDerivatives===null&&(this._standardDerivatives=de(this.gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return this._shaderTextureLOD===null&&(this._shaderTextureLOD=de(this.gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return this._fragDepth===null&&(this._fragDepth=de(this.gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=Sa(this.gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=Aa(this.gl,this._disabledExtensions)),this._textureNorm16}enable(t){return this[t]}}class Ma{constructor(t,e){this.gl=t,this.instanceCounter=new fa,this.programCache=new Fr(this),this._state=new Ui,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=W(t)?me.WEBGL2:me.WEBGL1,this._loadExtensions(),this.configure(e)}configure(t){this._capabilities=new Ca(this.gl,t),this._parameters=this._loadParameters(t);const e=this.gl.getParameter(this.gl.VIEWPORT);this._state=new Ui,this._state.viewport={x:e[0],y:e[1],width:e[2],height:e[3]},this._stateTracker=new Gr({setBlending:i=>{if(i){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(i.opRgb,i.opAlpha),this.setBlendFunctionSeparate(i.srcRgb,i.dstRgb,i.srcAlpha,i.dstAlpha);const s=i.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:i=>{i?(this.setFaceCullingEnabled(!0),this.setCullFace(i.face),this.setFrontFace(i.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:i=>{i?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(i.factor,i.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:i=>{i?(this.setDepthTestEnabled(!0),this.setDepthFunction(i.func)):this.setDepthTestEnabled(!1)},setStencilTest:i=>{if(i){this.setStencilTestEnabled(!0);const s=i.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=i.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:i=>{i?(this.setDepthWriteEnabled(!0),this.setDepthRange(i.zNear,i.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:i=>{i?this.setColorMask(i.r,i.g,i.b,i.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:i=>{i?this.setStencilWriteMask(i.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this._driverTest=new va(this)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(F.ARRAY_BUFFER),this.unbindBuffer(F.ELEMENT_ARRAY_BUFFER),W(this.gl)&&(this.unbindBuffer(F.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(F.PIXEL_PACK_BUFFER),this.unbindBuffer(F.PIXEL_UNPACK_BUFFER),this.unbindBuffer(F.COPY_READ_BUFFER),this.unbindBuffer(F.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,xt()&&this.instanceCounter.printResourceCount()}setPipelineState(t){this._stateTracker.setPipeline(t)}setBlendingEnabled(t){this._state.blend!==t&&(t===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=t,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var t;(t=this._state.program)==null||t.stop(),this._state.program=null}externalTextureUnitUpdate(t,e){for(let i=0;i<t.length;++i)this._state.textureUnitMap[t[i]]=null;e>=0&&(this._state.activeTexture=e)}externalVertexArrayObjectUpdate(){const t=this.capabilities.vao;t&&(t.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(t,e,i,s){t===this._state.blendColor.r&&e===this._state.blendColor.g&&i===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(t,e,i,s),this._state.blendColor.r=t,this._state.blendColor.g=e,this._state.blendColor.b=i,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(t,e){t===this._state.blendFunction.srcRGB&&e===this._state.blendFunction.dstRGB||(this.gl.blendFunc(t,e),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=t,this._state.blendFunction.dstRGB=e,this._state.blendFunction.dstAlpha=e,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(t,e,i,s){this._state.blendFunction.srcRGB===t&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===e&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(t,e,i,s),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=e,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(t){this._state.blendEquation.mode!==t&&(this.gl.blendEquation(t),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(t,e){this._state.blendEquation.mode===t&&this._state.blendEquation.modeAlpha===e||(this.gl.blendEquationSeparate(t,e),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setColorMask(t,e,i,s){this._state.colorMask.r===t&&this._state.colorMask.g===e&&this._state.colorMask.b===i&&this._state.colorMask.a===s||(this.gl.colorMask(t,e,i,s),this._state.colorMask.r=t,this._state.colorMask.g=e,this._state.colorMask.b=i,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(t,e,i,s){this._state.clearColor.r===t&&this._state.clearColor.g===e&&this._state.clearColor.b===i&&this._state.clearColor.a===s||(this.gl.clearColor(t,e,i,s),this._state.clearColor.r=t,this._state.clearColor.g=e,this._state.clearColor.b=i,this._state.clearColor.a=s)}setFaceCullingEnabled(t){this._state.faceCulling!==t&&(t===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=t,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(t){this._state.polygonOffsetFill!==t&&(t===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=t,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(t,e){this._state.polygonOffset[0]===t&&this._state.polygonOffset[1]===e||(this._state.polygonOffset[0]=t,this._state.polygonOffset[1]=e,this.gl.polygonOffset(t,e),this._stateTracker.invalidatePolygonOffset())}setCullFace(t){this._state.cullFace!==t&&(this.gl.cullFace(t),this._state.cullFace=t,this._stateTracker.invalidateCulling())}setFrontFace(t){this._state.frontFace!==t&&(this.gl.frontFace(t),this._state.frontFace=t,this._stateTracker.invalidateCulling())}setScissorTestEnabled(t){this._state.scissorTest!==t&&(t===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=t)}setScissorRect(t,e,i,s){this._state.scissorRect.x===t&&this._state.scissorRect.y===e&&this._state.scissorRect.width===i&&this._state.scissorRect.height===s||(this.gl.scissor(t,e,i,s),this._state.scissorRect.x=t,this._state.scissorRect.y=e,this._state.scissorRect.width=i,this._state.scissorRect.height=s)}setDepthTestEnabled(t){this._state.depthTest!==t&&(t===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=t,this._stateTracker.invalidateDepthTest())}setClearDepth(t){this._state.clearDepth!==t&&(this.gl.clearDepth(t),this._state.clearDepth=t)}setDepthFunction(t){this._state.depthFunction!==t&&(this.gl.depthFunc(t),this._state.depthFunction=t,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(t){this._state.depthWrite!==t&&(this.gl.depthMask(t),this._state.depthWrite=t,this._stateTracker.invalidateDepthWrite())}setDepthRange(t,e){this._state.depthRange.zNear===t&&this._state.depthRange.zFar===e||(this.gl.depthRange(t,e),this._state.depthRange.zNear=t,this._state.depthRange.zFar=e,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(t){this._state.stencilTest!==t&&(t===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=t,this._stateTracker.invalidateStencilTest())}setClearStencil(t){t!==this._state.clearStencil&&(this.gl.clearStencil(t),this._state.clearStencil=t)}setStencilFunction(t,e,i){this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===e&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(t,e,i),this._state.stencilFunction.face=Mt.FRONT_AND_BACK,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=e,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(t,e,i,s){this._state.stencilFunction.face===t&&this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(t,e,i,s),this._state.stencilFunction.face=t,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(t){this._state.stencilWriteMask!==t&&(this.gl.stencilMask(t),this._state.stencilWriteMask=t,this._stateTracker.invalidateStencilWrite())}setStencilOp(t,e,i){this._state.stencilOperation.face===Mt.FRONT_AND_BACK&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===e&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(t,e,i),this._state.stencilOperation.face=Mt.FRONT_AND_BACK,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=e,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(t,e,i,s){this._state.stencilOperation.face===t&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(t,e,i,s),this._state.stencilOperation.face=t,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(t,e=!1){const i=this._state.activeTexture;return t>=0&&(e||t!==this._state.activeTexture)&&(this.gl.activeTexture(we+t),this._state.activeTexture=t),i}clear(t){t&&this.gl.clear(t)}clearSafe(t,e=255){t&&(t&jt.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),t&jt.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),t&jt.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(e),this.gl.clear(t))}drawArrays(t,e,i){if(xt()&&(this._numOfDrawCalls++,this._numOfTriangles+=Gi(t,i)),this.gl.drawArrays(t,e,i),xt()){const s=ii(this);s&&console.error("drawArrays:",s)}}drawElements(t,e,i,s){if(xt()&&(this._numOfDrawCalls++,this._numOfTriangles+=Gi(t,e)),this.gl.drawElements(t,e,i,s),xt()){const a=ii(this);if(a){var n;const o=this.getBoundVAO(),h=o==null?void 0:o.indexBuffer,l={indexBuffer:h,vertexBuffers:o==null?void 0:o.vertexBuffers},d={mode:t,count:e,type:i,offset:s},c=(n=Ds(h,p=>p.size))!=null?n:0,_=s+e,f=c<_?`. Buffer is too small. Attempted to draw index ${_} of ${c}`:"";console.error(`drawElements: ${a}${f}`,{args:d,vao:l})}}}logIno(){xt()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}get capabilities(){return this._capabilities}setViewport(t,e,i,s){i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===t&&n.y===e&&n.width===i&&n.height===s||(n.x=t,n.y=e,n.width=i,n.height=s,this.gl.viewport(t,e,i,s))}getViewport(){return{x:this._state.viewport.x,y:this._state.viewport.y,width:this._state.viewport.width,height:this._state.viewport.height}}useProgram(t){var e,i;this._state.program!==t&&((e=this._state.program)==null||e.stop(),this._state.program=t,this.gl.useProgram((i=t==null?void 0:t.glName)!=null?i:null))}bindTexture(t,e,i=!1){(e>=this.parameters.maxTextureImageUnits||e<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[e];return N(t)||t.glName==null?(D(s)&&(this.setActiveTexture(e,i),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[e]=null,s):i||s!==t?(this.setActiveTexture(e,i),this.gl.bindTexture(t.descriptor.target,t.glName),t.applyChanges(),this._state.textureUnitMap[e]=t,s):(t.isDirty&&(this.setActiveTexture(e,i),t.applyChanges()),s)}unbindTextureAllUnits(t){for(let e=0;e<this.parameters.maxTextureImageUnits;e++)this._state.textureUnitMap[e]===t&&(this.bindTexture(null,e),this._state.textureUnitMap[e]=null)}bindFramebuffer(t,e=!1){if(e||this._state.readFramebuffer!==t||this._state.drawFramebuffer!==t){if(N(t))return this.gl.bindFramebuffer(rt.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);t.initializeAndBind(rt.FRAMEBUFFER),this._state.readFramebuffer=t,this._state.drawFramebuffer=t}}bindFramebufferSeparate(t,e,i=!1){const s=e===rt.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(i||n!==t)&&(N(t)?this.gl.bindFramebuffer(e,null):t.initializeAndBind(e),s?this._state.readFramebuffer=Ke(t,null):this._state.drawFramebuffer=Ke(t,null))}blitFramebuffer(t,e,i=0,s=0,n=t.width,a=t.height,o=0,h=0,l=e.width,d=e.height,c=jt.COLOR_BUFFER_BIT,_=S.NEAREST){this.bindFramebufferSeparate(t,rt.READ_FRAMEBUFFER),this.bindFramebufferSeparate(e,rt.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(i,s,n,a,o,h,l,d,c,_)}bindBuffer(t,e){if(t)switch(e!=null||(e=t.bufferType),e){case F.ARRAY_BUFFER:this._state.vertexBuffer=Z(this.gl,t,e,this._state.vertexBuffer);break;case F.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Z(this.gl,t,e,this._state.indexBuffer);break;case F.UNIFORM_BUFFER:this._state.uniformBuffer=Z(this.gl,t,e,this._state.uniformBuffer);break;case F.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Z(this.gl,t,e,this._state.pixelPackBuffer);break;case F.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Z(this.gl,t,e,this._state.pixelUnpackBuffer);break;case F.COPY_READ_BUFFER:this._state.copyReadBuffer=Z(this.gl,t,e,this._state.copyReadBuffer);break;case F.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Z(this.gl,t,e,this._state.copyWriteBuffer)}}bindRenderbuffer(t){const e=this.gl;t||(e.bindRenderbuffer(e.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==t&&(e.bindRenderbuffer(e.RENDERBUFFER,t.glName),this._state.renderbuffer=t)}_getBufferBinding(t,e){if(e>=this.parameters.maxUniformBufferBindings||e<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=this._state.uniformBufferBindingPoints;let s=i[e];return N(s)&&(s={buffer:null,offset:0,size:0},i[e]=s),s}bindBufferBase(t,e,i){const s=this._getBufferBinding(t,e);N(s)||s.buffer===i&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(t,e,i?i.glName:null),s.buffer=i,s.offset=0,s.size=0)}bindBufferRange(t,e,i,s,n){const a=this._getBufferBinding(t,e);if(!N(a)&&!(a.buffer===i&&a.offset===s&&a.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(t,e,i.glName,s,n),a.buffer=i,a.offset=s,a.size=n}}bindUBO(t,e,i,s){N(e)?this.bindBufferBase(F.UNIFORM_BUFFER,t,null):(xt()&&(s!=null?s:e.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),e.initialize(),i!==void 0&&s!==void 0?this.bindBufferRange(F.UNIFORM_BUFFER,t,e.buffer,i,s):this.bindBufferBase(F.UNIFORM_BUFFER,t,e.buffer))}unbindUBO(t){for(let e=0,i=this._state.uniformBufferBindingPoints.length;e<i;e++){const s=this._state.uniformBufferBindingPoints[e];D(s)&&s.buffer===t.buffer&&this.bindBufferBase(F.UNIFORM_BUFFER,e,null)}}unbindBuffer(t){switch(t){case F.ARRAY_BUFFER:this._state.vertexBuffer=Z(this.gl,null,t,this._state.vertexBuffer);break;case F.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Z(this.gl,null,t,this._state.indexBuffer);break;case F.UNIFORM_BUFFER:this._state.uniformBuffer=Z(this.gl,null,t,this._state.uniformBuffer);break;case F.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Z(this.gl,null,t,this._state.pixelPackBuffer);break;case F.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Z(this.gl,null,t,this._state.pixelUnpackBuffer);break;case F.COPY_READ_BUFFER:this._state.copyReadBuffer=Z(this.gl,null,t,this._state.copyReadBuffer);break;case F.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Z(this.gl,null,t,this._state.copyWriteBuffer)}}bindVAO(t=null){N(t)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==t&&(t.bind(),this._state.vertexArrayObject=t)}async clientWaitAsync(t=Is(10)){const e={};this.instanceCounter.increment(Qt.Sync,e);const i=this.gl,s=i.fenceSync(Sr.SYNC_GPU_COMMANDS_COMPLETE,0);let n;i.flush();do await Us(t),n=i.clientWaitSync(s,0,0);while(n===si.TIMEOUT_EXPIRED);if(i.deleteSync(s),this.instanceCounter.decrement(Qt.Sync,e),n===si.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(t=rt.FRAMEBUFFER){return t===rt.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(F.ARRAY_BUFFER),this.unbindBuffer(F.ELEMENT_ARRAY_BUFFER),W(this.gl)&&(this.unbindBuffer(F.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(F.PIXEL_PACK_BUFFER),this.unbindBuffer(F.PIXEL_UNPACK_BUFFER),this.unbindBuffer(F.COPY_READ_BUFFER),this.unbindBuffer(F.COPY_WRITE_BUFFER));for(let t=0;t<this.parameters.maxTextureImageUnits;++t)this.bindTexture(null,t);this.setBlendingEnabled(!1),this.setBlendFunction(R.ONE,R.ZERO),this.setBlendEquation(Ue.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(Mt.BACK),this.setFrontFace(Ji.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(zt.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(zt.ALWAYS,0,0),this.setStencilOp(mt.KEEP,mt.KEEP,mt.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var t,e;const i=this.gl,s=this.capabilities.vao;s&&s.bindVertexArray(null);for(let l=0;l<this.parameters.maxVertexAttributes;l++)i.disableVertexAttribArray(l);if(this._state.vertexBuffer?i.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):i.bindBuffer(F.ARRAY_BUFFER,null),this._state.indexBuffer?i.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):i.bindBuffer(F.ELEMENT_ARRAY_BUFFER,null),W(i)){var n,a;this._state.uniformBuffer?i.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):i.bindBuffer(F.UNIFORM_BUFFER,null);for(let l=0;l<this._parameters.maxUniformBufferBindings;l++){const d=this._state.uniformBufferBindingPoints[l];if(D(d)&&d.buffer!==null){const{buffer:c,offset:_,size:f}=d;_===0&&f===0?i.bindBufferBase(F.UNIFORM_BUFFER,l,c.glName):i.bindBufferRange(F.UNIFORM_BUFFER,l,c.glName,_,f)}else i.bindBufferBase(F.UNIFORM_BUFFER,l,null)}this._state.pixelPackBuffer?i.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):i.bindBuffer(F.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?i.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):i.bindBuffer(F.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?i.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):i.bindBuffer(F.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?i.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):i.bindBuffer(F.COPY_WRITE_BUFFER,null),i.bindFramebuffer(rt.READ_FRAMEBUFFER,null),i.readBuffer(i.BACK),this._state.readFramebuffer&&(i.bindFramebuffer(rt.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),i.readBuffer(Or.COLOR_ATTACHMENT0)),i.bindFramebuffer(rt.DRAW_FRAMEBUFFER,(n=(a=this._state.drawFramebuffer)==null?void 0:a.glName)!=null?n:null)}else{var o,h;this._state.readFramebuffer=this._state.drawFramebuffer,i.bindFramebuffer(rt.FRAMEBUFFER,(o=(h=this._state.drawFramebuffer)==null?void 0:h.glName)!=null?o:null)}if(s&&this._state.vertexArrayObject){const l=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(l)}i.useProgram((t=(e=this._state.program)==null?void 0:e.glName)!=null?t:null),i.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),i.bindRenderbuffer(i.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?i.enable(this.gl.BLEND):i.disable(this.gl.BLEND),i.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),i.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),i.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),i.clearDepth(this._state.clearDepth),i.clearStencil(this._state.clearStencil),i.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),i.cullFace(this._state.cullFace),i.depthFunc(this._state.depthFunction),i.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),i.depthMask(this._state.depthWrite),i.frontFace(this._state.frontFace),i.lineWidth(1),this._state.faceCulling===!0?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),i.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?i.enable(i.POLYGON_OFFSET_FILL):i.disable(i.POLYGON_OFFSET_FILL),i.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?i.enable(i.SCISSOR_TEST):i.disable(i.SCISSOR_TEST),i.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),i.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),i.stencilMask(this._state.stencilWriteMask);for(let l=0;l<this.parameters.maxTextureImageUnits;l++){i.activeTexture(we+l),i.bindTexture(I.TEXTURE_2D,null),i.bindTexture(I.TEXTURE_CUBE_MAP,null),W(i)&&(i.bindTexture(I.TEXTURE_3D,null),i.bindTexture(I.TEXTURE_2D_ARRAY,null));const d=this._state.textureUnitMap[l];D(d)&&i.bindTexture(d.descriptor.target,d.glName)}i.activeTexture(we+this._state.activeTexture),i.viewport(this._state.viewport.x,this._state.viewport.y,this._state.viewport.width,this._state.viewport.height),xt()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}_loadExtensions(){this.type===me.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(t){var e;const i=this.capabilities.textureFilterAnisotropic,s=(e=t.maxAnisotropy)!=null?e:1/0,n=W(this.gl),a=this.gl,o={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:i?Math.min(this.gl.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),s):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:n?a.getParameter(a.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:n?a.getParameter(a.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:n?a.getParameter(a.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:n?a.getParameter(a.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:n?a.getParameter(a.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:n?a.getParameter(a.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:n?a.getParameter(a.MAX_SAMPLES):1};return H.TEXTURE_UNIT_FOR_UPDATES=o.maxTextureImageUnits-1,o}}function Z(r,t,e,i){return t?i!==t&&r.bindBuffer(e,t.glName):r.bindBuffer(e,null),t}function Gi(r,t){switch(r){case X.POINTS:return 2*t;case X.TRIANGLES:return t/3;case X.TRIANGLE_STRIP:case X.TRIANGLE_FAN:return t-2;default:return 0}}const Pa=2e3;class rl extends Je{constructor(t,e){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=pt(),this._upperRight=pt(),this._lowerLeft=pt(),this._lowerRight=pt(),this._mat2=Ns(),this._clipRendererInitialized=!1,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:s=!0,stencil:n=!0,contextOptions:a={}}=e;this._canvas=i;const o=Ls("2d",i,{alpha:s,antialias:!1,depth:!0,stencil:n});this.context=new Ma(D(o)?o:null,a),this.resourceManager=new fr,this.painter=new ha(this.context,this,this.resourceManager),ge("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),t.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:e.timeline||new zs,renderingOptions:e.renderingOptions,requireFBO:!1,profiler:new ua(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=$s({render:h=>this.renderFrame(h)}),this._taskHandle.pause(),this._lostWebGLContextHandle=Gs(i,"webglcontextlost",()=>{this.emit("webgl-error",{error:new z("webgl-context-lost")})}),i.setAttribute("style","width: 100%; height:100%; display:block;"),t.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(t){this._background=t,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(t){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=t,this._highlightOptions&&(this._highlightOptionsHandle=qi(this._highlightOptions,"version",()=>{this.painter.setHighlightOptions(t),this.requestRender()}))}get renderingOptions(){return this._renderingOptions}set renderingOptions(t){this._renderingOptions=t,this.requestRender()}get state(){return this._state}set state(t){this._state=t,this.requestRender()}get stationary(){return this._stationary}set stationary(t){this._stationary!==t&&(this._stationary=t,this.requestRender())}trashDisplayObject(t){this._trash.add(t),this.requestRender()}untrashDisplayObject(t){return this._trash.delete(t)}requestRender(){this._renderRemainingTime=Pa,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(t){const e=this._lastFrameRenderTime?t.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=e,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=t.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=t.time,this._renderParameters.deltaTime=t.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:Yi()}}renderChildren(t){for(const e of this.children)e.beforeRender(t);this._renderChildren(this.children,t);for(const e of this.children)e.afterRender(t)}_renderChildren(t,e){const i=this.context;e.profiler.recordStart("drawLayers"),e.dataUploadCounter=0,this._beforeRenderChildren(e),e.drawPhase=Q.MAP,this.painter.beforeRenderLayers(i,this.background);for(const s of t)s.processRender(e);this.painter.renderLayers(i),e.drawPhase=Q.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const s of t)s.processRender(e);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(t)){e.drawPhase=Q.LABEL,this.painter.beforeRenderLayers(i);for(const s of t)s.processRender(e);this.painter.renderLayers(i)}if(ge("esri-tiles-debug")){e.drawPhase=Q.DEBUG,this.painter.beforeRenderLayers(i);for(const s of t)s.processRender(e);this.painter.renderLayers(i)}e.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(t){const{context:e}=this,{state:i,pixelRatio:s}=t;e.setClearDepth(1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT);const{size:n,rotation:a}=i,o=Math.round(n[0]*s),h=Math.round(n[1]*s);if(this._boundFBO=e.getBoundFramebufferObject(),!i.spatialReference.isWrappable)return void(this._clipFrame=!1);const l=qs(a),d=Math.abs(Math.cos(l)),c=Math.abs(Math.sin(l)),_=Math.round(o*d+h*c),f=Math.round(i.worldScreenWidth);if(_<=f)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===o&&this._clipFBO.height===h||(this._clipFBO=new $(e,{colorTarget:k.TEXTURE,depthStencilTarget:V.DEPTH_STENCIL_RENDER_BUFFER,width:o,height:h}));const p=(this.state.padding.left-this.state.padding.right)/2,u=(this.state.padding.bottom-this.state.padding.top)/2,m=.5*o,E=.5*h,g=1/o,T=1/h,b=f*s*.5,w=.5*(o*c+h*d),v=this._upperLeft,B=this._upperRight,A=this._lowerLeft,M=this._lowerRight;ft(v,-b,-w),ft(B,b,-w),ft(A,-b,w),ft(M,b,w),ks(this._mat2,[m+p,E-u]),a!==0&&Vs(this._mat2,this._mat2,l),ae(v,v,this._mat2),ae(B,B,this._mat2),ae(A,A,this._mat2),ae(M,M,this._mat2);const st=this._clipData;st.set([2*A[0]*g-1,2*(h-A[1])*T-1,2*M[0]*g-1,2*(h-M[1])*T-1,2*v[0]*g-1,2*(h-v[1])*T-1,2*B[0]*g-1,2*(h-B[1])*T-1]),this._clipRendererInitialized||this._initializeClipRenderer(e),this._clipVBO.setData(st),this._boundFBO=e.getBoundFramebufferObject(),e.bindFramebuffer(this._clipFBO),e.setDepthWriteEnabled(!0),e.setStencilWriteMask(255),e.setClearColor(0,0,0,0),e.setClearDepth(1),e.setClearStencil(0),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT|e.gl.STENCIL_BUFFER_BIT),e.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const t=this.context;if(t.logIno(),this._clipFrame&&this._clipRendererInitialized){if(t.bindFramebuffer(this._boundFBO),this._boundFBO=null,t.bindVAO(this._clipVAO),t.useProgram(this._clipStencilProgram),t.setDepthWriteEnabled(!1),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!1),t.setStencilOp(mt.KEEP,mt.KEEP,mt.REPLACE),t.setStencilWriteMask(255),t.setStencilFunction(zt.ALWAYS,1,255),t.drawElements(X.TRIANGLES,6,Pt.UNSIGNED_SHORT,0),t.bindVAO(),t.setColorMask(!0,!0,!0,!0),this.background!=null){const{r:e,g:i,b:s,a:n}=this.background.color;t.setClearColor(n*e/255,n*i/255,n*s/255,n)}else t.setClearColor(0,0,0,0);t.clear(t.gl.COLOR_BUFFER_BIT),t.setBlendingEnabled(!0),t.setStencilFunction(zt.EQUAL,1,255),this.painter.blitTexture(t,this._clipFBO.colorTexture,S.NEAREST,1),t.setStencilTestEnabled(!1)}}doRender(t){const e=this.context,{state:i,pixelRatio:s}=t;this._resizeCanvas(t),e.setViewport(0,0,s*i.size[0],s*i.size[1]),e.setDepthWriteEnabled(!0),e.setStencilWriteMask(255),super.doRender(t)}async takeScreenshot(t){const{framebufferWidth:e,framebufferHeight:i}={framebufferWidth:Math.round(this._renderParameters.state.size[0]*t.resolutionScale),framebufferHeight:Math.round(this._renderParameters.state.size[1]*t.resolutionScale)},s=1,n=this.context,a=this._state.clone();if(t.rotation!=null){const p=a.viewpoint;a.viewpoint.rotation=t.rotation,a.viewpoint=p}const o=At(j({},this._renderParameters),{drawPhase:null,globalOpacity:1,stationary:!0,state:a,pixelRatio:s,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),h=new $(n,{colorTarget:k.TEXTURE,depthStencilTarget:V.DEPTH_STENCIL_RENDER_BUFFER,width:e,height:i}),l=n.getBoundFramebufferObject(),d=n.getViewport();n.bindFramebuffer(h),n.setViewport(0,0,e,i),this._renderChildren(t.children,o);const c=this._readbackScreenshot(h,At(j({},t.cropArea),{y:i-(t.cropArea.y+t.cropArea.height)}));n.bindFramebuffer(l),n.setViewport(d.x,d.y,d.width,d.height),this.requestRender();const _=await c;let f;return t.outputScale===1?f=_:(f=new ImageData(Math.round(_.width*t.outputScale),Math.round(_.height*t.outputScale)),Ws(_,f,!0)),Xs(f,{format:t.format,quality:t.quality,rotation:0,disableDecorations:!1},document.createElement("canvas"),{flipY:!0,premultipliedAlpha:!0})}async _readbackScreenshot(t,e){const i=Hs(e.width,e.height,document.createElement("canvas"));return await t.readPixelsAsync(e.x,e.y,e.width,e.height,y.RGBA,O.UNSIGNED_BYTE,new Uint8Array(i.data.buffer)),i}_resizeCanvas(t){const e=this._canvas,i=e.style,{state:{size:s},pixelRatio:n}=t,a=s[0],o=s[1],h=Math.round(a*n),l=Math.round(o*n);e.width===h&&e.height===l||(e.width=h,e.height=l),i.width=a+"px",i.height=o+"px"}_initializeClipRenderer(t){if(this._clipRendererInitialized)return!0;const e=se(t,Ii);if(!e)return!1;const i=gt.createVertex(t,bt.STREAM_DRAW,this._clipData),s=new Uint16Array([0,1,2,2,1,3]),n=gt.createIndex(t,bt.STATIC_DRAW,s),a=Ii.attributes,o={geometry:[new $t("a_pos",2,Pt.FLOAT,0,8)]},h=new Bt(t,a,o,{geometry:i},n);return this._clipStencilProgram=e,this._clipVBO=i,this._clipVAO=h,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const t=Array.from(this._trash);this._trash.clear();for(const e of t)e.processDetach()}}_isLabelDrawPhaseRequired(t){let e=!1;for(const i of t){if(!(i instanceof Je)){e=e||!1;break}if(i.hasLabels)return!0;e=e||this._isLabelDrawPhaseRequired(i.children)}return e}}const ce=2,ht=1,Jt=0,te=1,ee=2;class Da{constructor(t,e){this.width=t,this.height=e;const i=Math.ceil(t/ht),s=Math.ceil(e/ht);this._cols=i,this._rows=s,this._cells=kr.create(i*s)}insertMetrics(t){const e=this._hasCollision(t);return e===Jt&&this._markMetrics(t),e}getCellId(t,e){return t+e*this._cols}has(t){return this._cells.has(t)}hasRange(t,e){return this._cells.hasRange(t,e)}set(t){this._cells.set(t)}setRange(t,e){this._cells.setRange(t,e)}_hasCollision(t){const e=t.id;let i=0,s=0;t.save();do{const n=t.boundsCount;i+=n;for(let a=0;a<n;a++){const o=t.boundsComputedAnchorX(a),h=t.boundsComputedAnchorY(a),l=t.boundsWidth(a)+ce,d=t.boundsHeight(a)+ce;switch(this._collide(o,h,l,d)){case ee:return ee;case te:s++}}}while(t.peekId()===e&&t.next());return t.restore(),i===s?te:Jt}_collide(t,e,i,s){const n=t-i/2,a=e-s/2,o=n+i,h=a+s;if(o<0||h<0||n>this.width||a>this.height)return te;const l=et(Math.floor(n/ht),0,this._cols),d=et(Math.floor(a/ht),0,this._rows),c=et(Math.ceil(o/ht),0,this._cols),_=et(Math.ceil(h/ht),0,this._rows);for(let f=d;f<=_;f++)for(let p=l;p<=c;p++){const u=this.getCellId(p,f);if(this.has(u))return ee}return Jt}_mark(t,e,i,s){const n=t-i/2,a=e-s/2,o=n+i,h=a+s,l=et(Math.floor(n/ht),0,this._cols),d=et(Math.floor(a/ht),0,this._rows),c=et(Math.ceil(o/ht),0,this._cols),_=et(Math.ceil(h/ht),0,this._rows);for(let f=d;f<=_;f++)for(let p=l;p<=c;p++){const u=this.getCellId(p,f);this.set(u)}return!1}_markMetrics(t){const e=t.id;do{const i=t.boundsCount;for(let s=0;s<i;s++){const n=t.boundsComputedAnchorX(s),a=t.boundsComputedAnchorY(s),o=t.boundsWidth(s)+ce,h=t.boundsHeight(s)+ce;this._mark(n,a,o,h)}}while(t.peekId()===e&&t.next())}}const Ia=Math.PI;function us(r,t){switch(t.transformationType){case Tt.Additive:return Ua(r,t);case Tt.Constant:return Na(t,r);case Tt.ClampedLinear:return La(r,t);case Tt.Proportional:return za(r,t);case Tt.Stops:return $a(r,t);case Tt.RealWorldSize:return Ga(r,t);case Tt.Identity:return r;case Tt.Unknown:return null}}function at(r,t){return typeof r=="number"?r:us(t,r)}function Ua(r,t){return r+(at(t.minSize,r)||t.minDataValue)}function Na(r,t){const e=r.stops;let i=e&&e.length&&e[0].size;return i==null&&(i=r.minSize),at(i,t)}function La(r,t){const e=(r-t.minDataValue)/(t.maxDataValue-t.minDataValue),i=at(t.minSize,r),s=at(t.maxSize,r);return r<=t.minDataValue?i:r>=t.maxDataValue?s:i+e*(s-i)}function za(r,t){const e=r/t.minDataValue,i=at(t.minSize,r),s=at(t.maxSize,r);let n=null;return n=e*i,et(n,i,s)}function $a(r,t){const[e,i,s]=ka(r,t.cache.ipData);if(e===i)return at(t.stops[e].size,r);{const n=at(t.stops[e].size,r);return n+(at(t.stops[i].size,r)-n)*s}}function Ga(r,t){const e=Ys[t.valueUnit],i=at(t.minSize,r),s=at(t.maxSize,r),{valueRepresentation:n}=t;let a=null;return a=n==="area"?2*Math.sqrt(r/Ia)/e:n==="radius"||n==="distance"?2*r/e:r/e,et(a,i,s)}function ka(r,t){if(!t)return;let e=0,i=t.length-1;return t.some((s,n)=>r<s?(i=n,!0):(e=n,!1)),[e,i,(r-t[e])/(t[i]-t[e])]}const Se=254,_e=255,Yt=0;function It(r,t){const e=[];r.forEachTile(i=>e.push(i)),e.sort((i,s)=>i.instanceId-s.instanceId),e.forEach(i=>{D(i.labelMetrics)&&i.isReady&&t(i,i.labelMetrics.getCursor())})}function Va(r){return r.layer.type==="feature"||r.layer.type==="csv"||r.layer.type==="geojson"||r.layer.type==="ogc-feature"||r.layer.type==="stream"||r.layer.type==="subtype-group"||r.layer.type==="wfs"}function Wa(r){return t=>yt(us(t,r))}function Xa(r){const t="visualVariables"in r&&r.visualVariables;if(!t)return null;for(const e of t)if(e.type==="size")return Wa(e);return null}function Ha(r){for(const e of r){var t;const i="featureReduction"in e&&((t=e.featureReduction)==null?void 0:t.type)==="cluster"&&e.featureReduction,s=[...e.labelingInfo||[],...i.labelingInfo||[]];if(!(!e.labelsVisible||!s.length)&&s.some(n=>n.deconflictionStrategy==="none"))return!0}return!1}function qa(r,t){if(!Va(t))return;const e=t.layer.type==="subtype-group"?t.layer.sublayers.items:[t.layer],i=t.layer.geometryType,s=!Ha(e),n={};if(t.layer.type!=="subtype-group"){if(t.layer.renderer.type==="heatmap")return;const h=Xa(t.layer.renderer);n[0]=h}const a=t.tileRenderer;if(N(a))return;const o=t.layer.visible&&!t.suspended;r.push({tileRenderer:a,vvEvaluators:n,deconflictionEnabled:s,geometryType:i,visible:o})}class Ya{run(t,e,i){const s=[];for(let n=t.length-1;n>=0;n--)qa(s,t[n]);this._transformMetrics(s,e),this._runCollision(s,e,i)}_runCollision(t,e,i){const[s,n]=e.state.size,a=new Da(s*e.pixelRatio,n*e.pixelRatio);for(const{tileRenderer:o,deconflictionEnabled:h,visible:l}of t){const d=o.featuresView.attributeView;h?l?(this._prepare(o),this._collideVisible(a,o,i),this._collideInvisible(a,o)):It(o,(c,_)=>{for(;_.nextId();)d.setLabelMinZoom(_.id,_e)}):It(o,(c,_)=>{for(;_.nextId();)d.setLabelMinZoom(_.id,Yt)})}}_isFiltered(t,e,i){const s=e.getFilterFlags(t),n=!i.hasFilter||!!(s&Ir),a=!D(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(s&Ur);return!(n&&a)}_prepare(t){const e=t.featuresView.attributeView,i=new Set;It(t,(s,n)=>{for(;n.nextId();)if(!i.has(n.id)){if(i.add(n.id),this._isFiltered(n.id,e,t.layerView)){e.setLabelMinZoom(n.id,Se);continue}e.getLabelMinZoom(n.id)!==Yt?e.setLabelMinZoom(n.id,_e):e.setLabelMinZoom(n.id,Yt)}})}_collideVisible(t,e,i){const s=e.featuresView.attributeView,n=new Set;It(e,(a,o)=>{for(;o.nextId();)if(!n.has(o.id))if(a.key.level===i){if(s.getLabelMinZoom(o.id)===0)switch(t.insertMetrics(o)){case te:break;case ee:s.setLabelMinZoom(o.id,Se),n.add(o.id);break;case Jt:s.setLabelMinZoom(o.id,Yt),n.add(o.id)}}else s.setLabelMinZoom(o.id,Se)})}_collideInvisible(t,e){const i=e.featuresView.attributeView,s=new Set;It(e,(n,a)=>{for(;a.nextId();)if(!s.has(a.id)&&i.getLabelMinZoom(a.id)===_e)switch(t.insertMetrics(a)){case te:break;case ee:i.setLabelMinZoom(a.id,_e),s.add(a.id);break;case Jt:i.setLabelMinZoom(a.id,Yt),s.add(a.id)}})}_transformMetrics(t,e){for(const{tileRenderer:i,geometryType:s,vvEvaluators:n}of t)It(i,(a,o)=>{const h=i.featuresView.attributeView,l=a.transforms.labelMat2d;l[4]=Math.round(l[4]),l[5]=Math.round(l[5]);const d=l[4],c=l[5],_=s==="polyline";for(;o.next();){const f=o.boundsCount,p=o.anchorX,u=o.anchorY;let m=o.size;const E=n[0];if(D(E)){const b=E(h.getVVSize(o.id));m=isNaN(b)||b==null||b===1/0?m:b}const g=o.directionX*(m/2),T=o.directionY*(m/2);for(let b=0;b<f;b++){let w=p,v=o.anchorY;if(_){let B=w+o.boundsX(b)+g,A=v+o.boundsY(b)+T;e.state.rotation?(B=l[0]*B+l[2]*A+l[4],A=l[1]*B+l[3]*A+l[5]):(B+=d,A+=c),o.setBoundsComputedAnchorX(b,Math.floor(B)),o.setBoundsComputedAnchorY(b,Math.floor(A))}else{e.state.rotation?(w=l[0]*p+l[2]*u+l[4],v=l[1]*p+l[3]*u+l[5]):(w+=d,v+=c);const B=w+o.boundsX(b)+g,A=v+o.boundsY(b)+T;o.setBoundsComputedAnchorX(b,B),o.setBoundsComputedAnchorY(b,A)}}}})}}const ja=32,Ka=re.getLogger("esri.views.2d.layers.labels.LabelManager");let Ct=class extends js(Gt){constructor(r){super(r),this._applyVisibilityPassThrottled=Ks(this._applyVisibilityPass,ja,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new Ya}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(r){this._applyVisibilityPassThrottled(r)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(r){this._set("updateParameters",r),this.updateRequested&&(this.updateRequested=!1,this.update(r))}_applyVisibilityPass(r){try{const t=this.view.featuresTilingScheme.getClosestInfoForScale(r.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,r,t)}catch(t){Ka.error(new z("mapview-labeling","Encountered an error during label decluttering",t))}}};P([L()],Ct.prototype,"updateRequested",void 0),P([L({readOnly:!0})],Ct.prototype,"updateParameters",void 0),P([L()],Ct.prototype,"updating",null),P([L()],Ct.prototype,"view",void 0),Ct=P([kt("esri.views.2d.layers.labels.LabelManager")],Ct);const nl=Ct,fe={container:"esri-zoom-box__container",overlay:"esri-zoom-box__overlay",background:"esri-zoom-box__overlay-background",box:"esri-zoom-box__outline"},Oe={zoom:"Shift",counter:"Ctrl"};let Kt=class extends Gt{constructor(r){super(r),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(r){this._handles&&this._handles.forEach(t=>{t.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",r),r&&(r.on("drag",[Oe.zoom],t=>this._handleDrag(t,1),Ze.INTERNAL),r.on("drag",[Oe.zoom,Oe.counter],t=>this._handleDrag(t,-1),Ze.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(r,t,e,i){this._box.x=r,this._box.y=t,this._box.width=e,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(r,t,e,i,s){const n=this.view,a=n.toMap(Zs(r+.5*e,t+.5*i));let o=Math.max(e/n.width,i/n.height);s===-1&&(o=1/o),this._destroyOverlay(),this.navigation.end(),n.goTo({center:a,scale:n.scale*o})}_updateBox(r,t,e,i){const s=this._boxShape;s.setAttributeNS(null,"x",""+r),s.setAttributeNS(null,"y",""+t),s.setAttributeNS(null,"width",""+e),s.setAttributeNS(null,"height",""+i),s.setAttributeNS(null,"class",fe.box)}_updateBackground(r,t,e,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(r,t,e,i,this.view.width,this.view.height))}_createContainer(){const r=document.createElement("div");r.className=fe.container,this.view.root.appendChild(r),this._container=r}_createOverlay(){const r=this.view.width,t=this.view.height,e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttributeNS(null,"d","M 0 0 L "+r+" 0 L "+r+" "+t+" L 0 "+t+" Z"),e.setAttributeNS(null,"class",fe.background);const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),s.setAttributeNS(null,"class",fe.overlay),s.appendChild(e),s.appendChild(i),this._container.appendChild(s),this._backgroundShape=e,this._boxShape=i,this._overlay=s}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(r,t,e,i,s,n){const a=r+e,o=t+i;return"M 0 0 L "+s+" 0 L "+s+" "+n+" L 0 "+n+" ZM "+r+" "+t+" L "+r+" "+o+" L "+a+" "+o+" L "+a+" "+t+" Z"}_handleDrag(r,t){const e=r.x,i=r.y,s=r.origin.x,n=r.origin.y;let a,o,h,l;switch(e>s?(a=s,h=e-s):(a=e,h=s-e),i>n?(o=n,l=i-n):(o=i,l=n-i),r.action){case"start":this._start();break;case"update":this._update(a,o,h,l);break;case"end":this._end(a,o,h,l,t)}r.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:r,y:t,width:e,height:i}=this._box;this._updateBox(r,t,e,i),this._updateBackground(r,t,e,i),this._rafId=requestAnimationFrame(this._redraw)}};P([L()],Kt.prototype,"navigation",void 0),P([L()],Kt.prototype,"view",null),Kt=P([kt("esri.views.2d.navigation.ZoomBox")],Kt);const Za=Kt;class wt{constructor(t){this.gain=t}update(t){if(this.hasLastValue){const e=this.computeDelta(t);this._updateDelta(e)}this.lastValue=t}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return this.lastValue!==void 0}get hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(t){return t-this.lastValue}_updateDelta(t){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*t:this.filteredDelta=t}}class We{constructor(t,e,i){this._initialVelocity=t,this._stopVelocity=e,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(t){return t>this.duration}get friction(){return this._friction}value(t){return this.valueFromInitialVelocity(this._initialVelocity,t)}valueDelta(t,e){const i=this.value(t);return this.value(t+e)-i}valueFromInitialVelocity(t,e){e=Math.min(e,this.duration);const i=1-this.friction;return t*(i**e-1)/Math.log(i)}}class Qa extends We{constructor(t,e,i,s,n){super(t,e,i),this.sceneVelocity=s,this.direction=n}value(t){return super.valueFromInitialVelocity(this.sceneVelocity,t)}}class Ja{constructor(t=300,e=12,i=.84){this.minimumInitialVelocity=t,this.stopVelocity=e,this.friction=i,this.enabled=!0,this.time=new wt(.6),this.screen=[new wt(.4),new wt(.4)],this.scene=[new wt(.6),new wt(.6),new wt(.6)],this.tmpDirection=ji()}add(t,e,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.scene[0].update(e[0]),this.scene[1].update(e[1]),this.scene[2].update(e[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,e=this.screen[1].filteredDelta,i=Math.sqrt(t*t+e*e)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(t,e,i){Qs(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=Js(this.tmpDirection);s>0&&Ki(this.tmpDirection,this.tmpDirection,1/s);const n=s/this.time.filteredDelta;return new Qa(t,e,i,n,this.tmpDirection)}}let Ut=class extends Gt{constructor(r){super(r),this.animationTime=0,this.momentumEstimator=new Ja(500,6,.92),this.momentum=null,this.tmpMomentum=ji(),this.momentumFinished=!1,this.viewpoint=new Ee({targetGeometry:new Te,scale:0,rotation:0}),tr(()=>this.momentumFinished,()=>this.navigation.stop())}begin(r,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this.previousDrag=t}update(r,t){this.addToEstimator(t);let e=t.center.x,i=t.center.y;const s=this.previousDrag;e=s?s.center.x-e:-e,i=s?i-s.center.y:i,r.viewpoint=be(this.viewpoint,r.viewpoint,[e||0,i||0]),this.previousDrag=t}end(r,t){this.addToEstimator(t);const e=r.navigation.momentumEnabled;this.momentum=e?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(r),this.previousDrag=null,this.navigation.end()}addToEstimator(r){const t=r.center.x,e=r.center.y,i=er(-t,e),s=De(-t,e,0);this.momentumEstimator.add(i,s,.001*r.timestamp)}onAnimationUpdate(r){this.navigation.animationManager.animateContinous(r.viewpoint,(t,e)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const i=.001*e;if(!this.momentumFinished){const s=this.momentum.valueDelta(this.animationTime,i);Ki(this.tmpMomentum,this.momentum.direction,s),be(t,t,this.tmpMomentum),r.constraints.constrainByGeometry(t)}this.animationTime+=i})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};P([L()],Ut.prototype,"momentumFinished",void 0),P([L()],Ut.prototype,"viewpoint",void 0),P([L()],Ut.prototype,"navigation",void 0),Ut=P([kt("esri.views.2d.navigation.actions.Pan")],Ut);const to=Ut;class ds{constructor(t=2.5,e=.01,i=.95,s=12){this.minimumInitialVelocity=t,this.stopVelocity=e,this.friction=i,this.maxVelocity=s,this.enabled=!0,this.value=new wt(.8),this.time=new wt(.3)}add(t,e){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(e)<.01)return;if(this.value.hasFilteredDelta){const i=this.value.computeDelta(t);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(e),this.value.update(t)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let t=this.value.filteredDelta/this.time.filteredDelta;return t=et(t,-this.maxVelocity,this.maxVelocity),Math.abs(t)<this.minimumInitialVelocity?null:this.createMomentum(t,this.stopVelocity,this.friction)}createMomentum(t,e,i){return new We(t,e,i)}}class eo extends ds{constructor(t=3,e=.01,i=.95,s=12){super(t,e,i,s)}add(t,e){if(this.value.hasLastValue){const i=this.value.lastValue;let s=t-i;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;t=i+s}super.add(t,e)}}class io extends We{constructor(t,e,i){super(t,e,i)}value(t){const e=super.value(t);return Math.exp(e)}valueDelta(t,e){const i=super.value(t),s=super.value(t+e)-i;return Math.exp(s)}}class so extends ds{constructor(t=2.5,e=.01,i=.95,s=12){super(t,e,i,s)}add(t,e){super.add(Math.log(t),e)}createMomentum(t,e,i){return new io(t,e,i)}}let Nt=class extends Gt{constructor(r){super(r),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new eo(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new so,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new Ee({targetGeometry:new Te,scale:0,rotation:0}),this.watch("_momentumFinished",t=>{t&&this.navigation.stop()})}begin(r,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,r.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}update(r,t){this._updateTimestamp===null&&(this._updateTimestamp=t.timestamp);const e=t.angle,i=t.radius,s=t.center,n=Math.abs(180*(e-this._startAngle)/Math.PI),a=Math.abs(i-this._startRadius),o=this._startRadius/i;if(this._previousRadius){const h=i/this._previousRadius;let l=180*(e-this._previousAngle)/Math.PI;this._rotationDirection=l>=0?1:-1,this._zoomDirection=h>=1?1:-1,r.constraints.rotationEnabled?(this._zoomOnly===null&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=a-n>0),this._zoomOnly===null||this._zoomOnly?l=0:this.addToRotateEstimator(e-this._startAngle,t.timestamp)):l=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([s.x,s.y],1/h,l,[this._previousCenter.x-s.x,s.y-this._previousCenter.y])}this._previousAngle=e,this._previousRadius=i,this._previousCenter=s}end(r){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(r),this.navigation.end()}addToRotateEstimator(r,t){this._rotationMomentumEstimator.add(r,.001*t)}addToZoomEstimator(r,t){this._zoomMomentumEstimator.add(t,.001*r.timestamp)}canZoomIn(r){const t=r.scale,e=r.constraints.effectiveMaxScale;return e===0||t>e}canZoomOut(r){const t=r.scale,e=r.constraints.effectiveMinScale;return e===0||t<e}onAnimationUpdate(r){this.navigation.animationManager.animateContinous(r.viewpoint,(t,e)=>{const i=!this.canZoomIn(r)&&this._zoomDirection>1||!this.canZoomOut(r)&&this._zoomDirection<1,s=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=i||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),a=.001*e;if(this._momentumFinished=s&&n,!this._momentumFinished){const o=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,a))*this._rotationDirection*180/Math.PI:0;let h=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,a)):1;const l=pt(),d=pt();if(this._previousCenter){ft(l,this._previousCenter.x,this._previousCenter.y),ir(d,r.size,r.padding),sr(l,l,d);const{constraints:c,scale:_}=r,f=_*h;h<1&&!c.canZoomInTo(f)?(h=_/c.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):h>1&&!c.canZoomOutTo(f)&&(h=_/c.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),rr(t,r.viewpoint,h,o,l,r.size),r.constraints.constrainByGeometry(t)}}this._animationTime+=a})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};P([L()],Nt.prototype,"_momentumFinished",void 0),P([L()],Nt.prototype,"viewpoint",void 0),P([L()],Nt.prototype,"navigation",void 0),Nt=P([kt("esri.views.2d.navigation.actions.Pinch")],Nt);const ro=Nt,Ce=pt(),ki=pt();let Zt=class extends Gt{constructor(r){super(r),this._previousCenter=pt(),this.viewpoint=new Ee({targetGeometry:new Te,scale:0,rotation:0})}begin(r,t){this.navigation.begin(),ft(this._previousCenter,t.center.x,t.center.y)}update(r,t){const{state:{size:e,padding:i}}=r;ft(Ce,t.center.x,t.center.y),nr(ki,e,i),r.viewpoint=Ie(this.viewpoint,r.state.paddedViewState.viewpoint,ar(ki,this._previousCenter,Ce)),or(this._previousCenter,Ce)}end(){this.navigation.end()}};P([L()],Zt.prototype,"viewpoint",void 0),P([L()],Zt.prototype,"navigation",void 0),Zt=P([kt("esri.views.2d.actions.Rotate")],Zt);const no=Zt,pe=10,Vi=1,Me=new Ee({targetGeometry:new Te}),Pe=[0,0],Wi=250;let ut=class extends Gt{constructor(r){super(r),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new to({navigation:this}),this.rotate=new no({navigation:this}),this.pinch=new ro({navigation:this}),this.zoomBox=new Za({view:this.view,navigation:this})}destroy(){this.pan.destroy(),this.rotate.destroy(),this.pinch.destroy(),this.zoomBox.destroy(),this.pan=this.rotate=this.pinch=this.zoomBox=this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(Wi)}async zoom(r,t=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return r<1?this.zoomIn(t):this.zoomOut(t);this.setViewpoint(t,r,0,[0,0])}async zoomIn(r){const t=this.view,e=t.constraints.snapToNextScale(t.scale);return this._zoomToScale(e,r)}async zoomOut(r){const t=this.view,e=t.constraints.snapToPreviousScale(t.scale);return this._zoomToScale(e,r)}setViewpoint(r,t,e,i){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,r,t,e,i),this.end()}setViewpointImmediate(r,t=0,e=[0,0],i=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,r,t,e)}continousRotateClockwise(){const r=this.get("view.viewpoint");this.animationManager.animateContinous(r,t=>{Ie(t,t,-Vi)})}continousRotateCounterclockwise(){const r=this.get("view.viewpoint");this.animationManager.animateContinous(r,t=>{Ie(t,t,Vi)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-pe,0])}continousPanRight(){this._continuousPan([pe,0])}continousPanUp(){this._continuousPan([0,pe])}continousPanDown(){this._continuousPan([0,-pe])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),this._endTimer!==null&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(r){const t=this.view.viewpoint;this.animationManager.animateContinous(t,e=>{be(e,e,r),this.view.constraints.constrainByGeometry(e)})}_startTimer(r){return this._endTimer!==null||(this._endTimer=setTimeout(()=>{this._endTimer=null;const t=performance.now()-this._lastEventTimestamp;t<Wi?this._endTimer=this._startTimer(t):this._set("interacting",!1)},r)),this._endTimer}_getDefaultAnchor(){const{size:r,padding:{left:t,right:e,top:i,bottom:s}}=this.view;return Pe[0]=.5*(r[0]-e+t),Pe[1]=.5*(r[1]-s+i),Pe}async _zoomToScale(r,t=this._getDefaultAnchor()){const{view:e}=this,{constraints:i,scale:s,viewpoint:n,size:a,padding:o}=e,h=i.canZoomInTo(r),l=i.canZoomOutTo(r);if(!(r<s&&!h||r>s&&!l))return Qe(Me,n,r/s,0,t,a,o),i.constrainByGeometry(Me),e.goTo(Me,{animate:!0})}_scaleRotateTranslateViewpoint(r,t,e,i,s){const{view:n}=this,{size:a,padding:o,constraints:h,scale:l,viewpoint:d}=n,c=l*e,_=h.canZoomInTo(c),f=h.canZoomOutTo(c);return(e<1&&!_||e>1&&!f)&&(e=1),be(d,d,s),Qe(r,d,e,i,t,a,o),h.constrainByGeometry(r)}};P([L()],ut.prototype,"animationManager",void 0),P([L({type:Boolean,readOnly:!0})],ut.prototype,"interacting",void 0),P([L()],ut.prototype,"pan",void 0),P([L()],ut.prototype,"pinch",void 0),P([L()],ut.prototype,"rotate",void 0),P([L()],ut.prototype,"view",void 0),P([L()],ut.prototype,"zoomBox",void 0),ut=P([kt("esri.views.2d.navigation.MapViewNavigation")],ut);const al=ut,cs={shaders:{vertexShader:J("magnifier/magnifier.vert"),fragmentShader:J("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function ao(r){return se(r,cs)}async function oo(r){const t=ui(()=>import("./mask-svg.318fc328.js"),[]),e=ui(()=>import("./overlay-svg.5292dcb7.js"),[]),i=hi((await t).default,{signal:r}),s=hi((await e).default,{signal:r}),n={mask:await i,overlay:await s};return Hi(r),n}class ol extends pr{constructor(){super(),this._handles=new lr,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(t){this._background=t,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(t){this._magnifier=t,this._handles.removeAll(),this._handles.add([qi(t,"version",()=>{this.visible=t.visible&&D(t.position)&&t.size>0,this.requestRender()}),t.watch(["mask","overlay"],()=>this._reloadResources()),t.watch("size",()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{dvs:Yi()}}doRender(t){var e;const i=t.context;if(!this._resourcesTask)return void this._reloadResources();if(t.drawPhase!==Q.MAP||!this._canRender())return;this._updateResources(t);const s=this._magnifier;if(N(s.position))return;const n=t.pixelRatio,a=s.size*n,o=1/s.factor,h=Math.ceil(o*a);this._readbackTexture.resize(h,h);const{size:l}=t.state,d=n*l[0],c=n*l[1],_=.5*h,f=.5*h,p=et(n*s.position.x,_,d-_-1),u=et(c-n*s.position.y,f,c-f-1);i.setBlendingEnabled(!0);const m=p-_,E=u-f,g=this._readbackTexture;i.bindTexture(g,0),i.gl.copyTexImage2D(g.descriptor.target,0,g.descriptor.pixelFormat,m,E,h,h,0);const T=(e=this.background)==null?void 0:e.color,b=T?[T.a*T.r/255,T.a*T.g/255,T.a*T.b/255,T.a]:[1,1,1,1],w=(p+s.offset.x*n)/d*2-1,v=(u-s.offset.y*n)/c*2-1,B=a/d*2,A=a/c*2,M=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(M),M.setUniform4fv("u_background",b),M.setUniform1i("u_readbackTexture",0),M.setUniform1i("u_overlayTexture",6),M.setUniform1i("u_maskTexture",7),M.setUniform4f("u_drawPos",w,v,B,A),M.setUniform1i("u_maskEnabled",s.maskEnabled?1:0),M.setUniform1i("u_overlayEnabled",s.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(X.TRIANGLE_STRIP,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&this._magnifier!=null}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const t=D(this._magnifier)?this._magnifier.maskUrl:null,e=D(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=hr(async i=>{const s=N(t)||N(e)?oo(i):null,n=D(t)?ie(t,{responseType:"image",signal:i}).then(l=>l.data):s.then(l=>l.mask),a=D(e)?ie(e,{responseType:"image",signal:i}).then(l=>l.data):s.then(l=>l.overlay),[o,h]=await Promise.all([n,a]);this.mask=o,this.overlay=h,this._disposeRenderResources(),this.requestRender()})}_disposeRenderResources(){this._readbackTexture=ct(this._readbackTexture),this._overlayTexture=ct(this._overlayTexture),this._maskTexture=ct(this._maskTexture),this._vertexArrayObject=ct(this._vertexArrayObject),this._program=ct(this._program)}_updateResources(t){if(t.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const e=t.context;this._resourcePixelRatio=t.pixelRatio;const i=Math.ceil(this._magnifier.size*t.pixelRatio);this._program=ao(e);const s=new Uint16Array([0,1,0,0,1,1,1,0]),n=cs.attributes;this._vertexArrayObject=new Bt(e,n,Qi,{geometry:gt.createVertex(e,bt.STATIC_DRAW,s)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new H(e,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.NEAREST,flipped:!0,preMultiplyAlpha:!ur(this.overlay.src)||!t.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new H(e,{target:I.TEXTURE_2D,pixelFormat:y.ALPHA,internalFormat:y.ALPHA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.NEAREST,flipped:!0},this.mask);const a=1/this._magnifier.factor;this._readbackTexture=new H(e,{target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:O.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:Math.ceil(a*i),height:Math.ceil(a*i)})}}export{cl as GraphicContainer,ul as GraphicsView2D,nl as LabelManager,ol as MagnifierView2D,al as MapViewNavigation,rl as Stage};
