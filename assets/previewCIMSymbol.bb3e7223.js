import{aC as J,k as j,c9 as q,C as B,bt as y,x as z,ij as K,bf as Q,c7 as Z,ik as $,il as U,au as E,av as ee,ib as te,im as ae,io as ie,ih as re,bc as ne}from"./GISSearch.b73a2371.js";import{H as se,o as oe}from"./cimAnalyzer.74547477.js";import{e as ce,s as le}from"./CIMSymbolHelper.1040926f.js";import{m as me}from"./Rasterizer.8006df47.js";import"./index.8ac88fb7.js";import"./ProjectWeberRenew.dc78a7b0.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./enums.84480fc7.js";import"./quantizationUtils.48cd94ed.js";import"./BidiEngine.b9926823.js";import"./alignmentUtils.03ee467b.js";import"./number.dc47462b.js";import"./GeometryUtils.e53da643.js";var F;(function(m){m.Legend="legend",m.Preview="preview"})(F||(F={}));const D=(m,e,t)=>{if(m&&m.targetSize){let n;if(t){const i=Math.max(t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin);n=m.targetSize/z(i)}else n=m.targetSize/e.referenceSize;return n}return m&&m.scaleFactor?m.scaleFactor:1},N={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class he{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new ce,this._cimResourceManager=new le,this._rasterizer=new me(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,n,i,a,r,o,s){i=i||(t?t.centroid!=null?"esriGeometryPolygon":J(t.geometry):null)||ge(e);const c=await this.analyzeCIMSymbol(e,t?fe(t.attributes):null,n,i,s);return this.rasterizeCIMSymbol(c,t,i,a,r,o)}async analyzeCIMSymbol(e,t,n,i,a){const r=[],o=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null;let s;await se(e.data,o,this._cimResourceManager,r,this._avoidSDF),j(a);for(const c of r)c.cim.type!=="CIMPictureMarker"&&c.cim.type!=="CIMPictureFill"&&c.cim.type!=="CIMPictureStroke"||(s||(s=[]),s.push(this._fetchPictureMarkerResource(c,a))),n&&c.type==="text"&&typeof c.text=="string"&&c.text.indexOf("[")>-1&&(c.text=q(n,c.text,c.cim.textCase));return s&&await Promise.all(s),r}async _fetchPictureMarkerResource(e,t){const n=e.materialHash;if(!this._pictureMarkerCache.get(n)){const i=(await B(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(n,i)}}rasterizeCIMSymbol(e,t,n,i,a,r){const o=[];for(const s of e){i&&typeof i.scaleFactor=="function"&&(i.scaleFactor=i.scaleFactor(t,a,r));const c=this._getRasterizedResource(s,t,n,i,a,r);if(!c)continue;let M=0,w=c.anchorX||0,p=c.anchorY||0,l=!1,g=0,f=0;if(n==="esriGeometryPoint"){const h=D(i,s,null);if(g=y(s.offsetX,t,a,r)*h||0,f=y(s.offsetY,t,a,r)*h||0,s.type==="marker")M=y(s.rotation,t,a,r)||0,l=!!s.rotateClockwise&&s.rotateClockwise;else if(s.type==="text"){if(M=y(s.angle,t,a,r)||0,s.horizontalAlignment!==void 0)switch(s.horizontalAlignment){case"left":w=-.5;break;case"right":w=.5;break;default:w=0}if(s.verticalAlignment!==void 0)switch(s.verticalAlignment){case"top":p=.5;break;case"bottom":p=-.5;break;case"baseline":p=-.25;break;default:p=0}}}c!=null&&o.push({angle:M,rotateClockWise:l,anchorX:w,anchorY:p,offsetX:g,offsetY:f,rasterizedResource:c})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),n=t.getContext("2d");let i=0,a=0,r=0,o=0;const s=[];for(let p=0;p<e.length;p++){const l=e[p],g=l.rasterizedResource;if(!g)continue;const f=g.size,h=l.offsetX,u=l.offsetY,d=l.anchorX,C=l.anchorY,I=l.rotateClockWise||!1;let x=l.angle,P=z(h)-f[0]*(.5+d),_=z(u)-f[1]*(.5+C),k=P+f[0],S=_+f[1];if(x){I&&(x=-x);const b=Math.sin(x*Math.PI/180),v=Math.cos(x*Math.PI/180),T=P*v-_*b,X=P*b+_*v,Y=P*v-S*b,O=P*b+S*v,G=k*v-S*b,H=k*b+S*v,L=k*v-_*b,V=k*b+_*v;P=Math.min(T,Y,G,L),_=Math.min(X,O,H,V),k=Math.max(T,Y,G,L),S=Math.max(X,O,H,V)}i=P<i?P:i,a=_<a?_:a,r=k>r?k:r,o=S>o?S:o;const A=n.createImageData(g.size[0],g.size[1]);A.data.set(new Uint8ClampedArray(g.image.buffer));const W={offsetX:h,offsetY:u,rotateClockwise:I,angle:x,rasterizedImage:A,anchorX:d,anchorY:C};s.push(W)}t.width=r-i,t.height=o-a;const c=-i,M=o;for(let p=0;p<s.length;p++){const l=s[p],g=this._imageDataToCanvas(l.rasterizedImage),f=l.rasterizedImage.width,h=l.rasterizedImage.height,u=c-f*(.5+l.anchorX),d=M-h*(.5-l.anchorY);if(l.angle){const C=(360-l.angle)*Math.PI/180;n.save(),n.translate(z(l.offsetX),-z(l.offsetY)),n.translate(c,M),n.rotate(C),n.translate(-c,-M),n.drawImage(g,u,d),n.restore()}else n.drawImage(g,u+z(l.offsetX),d-z(l.offsetY))}const w=new K({x:c/t.width-.5,y:M/t.height-.5});return{imageData:t.width!==0&&t.height!==0?n.getImageData(0,0,t.width,t.height):n.createImageData(1,1),anchorPosition:w}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,n=t.getContext("2d");return t.width=e.width,t.height=e.height,n.putImageData(e,0,0),t}_imageTo32Array(e,t,n,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,r=a.getContext("2d");if(a.width=t,a.height=n,r.drawImage(e,0,0,t,n),i){r.save();const o=new Q(i);r.fillStyle=o.toHex(),r.globalCompositeOperation="multiply",r.fillRect(0,0,t,n),r.globalCompositeOperation="destination-atop",r.drawImage(e,0,0,t,n),r.restore()}return new Uint32Array(r.getImageData(0,0,t,n).data.buffer)}_getRasterizedResource(e,t,n,i,a,r){let o,s,c,M,w=null,p=null;if(n==="esriGeometryPolyline"||n==="esriGeometryPolygon"){const g=i&&i.style?i.style:F.Legend,f=n==="esriGeometryPolyline"?N.stroke[g]:N.fill[g];if(e.type==="line"){if(e.cim.type!=="CIMSolidStroke"){if(e.cim.type==="CIMPictureStroke"){const h=y(e.width,t,a,r),u=y(e.color,t,a,r),{image:d,width:C,height:I}=this._getPictureResource(e,h,u);return this._rasterizePictureResource(e,d,C,I,f,h)}return null}({analyzedCIM:o,hash:c}=R(e,t,a,r)),s=this._embedCIMLayerInVectorMarker(o,f)}else if(e.type==="marker"){if(e.cim.type==="CIMPictureMarker"){const h=y(e.size,t,a,r),u=y(e.color,t,a,r),{image:d,width:C,height:I}=this._getPictureResource(e,h,u);return this._rasterizePictureResource(e,d,C,I,f,h)}if(e.cim.type!=="CIMVectorMarker")return null;e.cim.offsetX=y(e.offsetX,t,a,r),e.cim.offsetY=y(e.offsetY,t,a,r),e.cim.rotation=y(e.rotation,t,a,r),e.cim.markerPlacement=e.markerPlacement,{analyzedCIM:o}=R(e,t,a,r),c=Z(JSON.stringify(o)).toString(),s=this._embedCIMLayerInVectorMarker(o,f),w=y(e.size,t,a,r),p=e.path}else{if(e.type==="text")return null;if(e.type==="fill"){if(e.cim.type==="CIMHatchFill"||e.cim.type==="CIMVectorMarker"||e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill"){const h=e.cim.size||e.cim.height;let u,d,C;if(e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill")({image:u,width:d,height:C}=this._getPictureResource(e,h,y(e.color,t,a,r)));else{({analyzedCIM:o,hash:c}=R(e,t,a,r));const I=this._rasterizer.rasterizeJSONResource({cim:o,type:e.type,url:e.url,mosaicHash:c,size:h,path:p},1,this._avoidSDF);u=I.image,d=I.size[0],C=I.size[1]}return this._rasterizePictureResource(e,u,d,C,f,null)}if(e.cim.type!=="CIMSolidFill")return null;({analyzedCIM:o,hash:c}=R(e,t,a,r)),s=this._embedCIMLayerInVectorMarker(o,f)}}}else{if(e.type==="text")return M=this._rasterizeTextResource(e,t,i,a,r),M;({analyzedCIM:o,hash:c}=R(e,t,a,r));const g=D(i,e,null);if(e.cim.type==="CIMPictureMarker"){const f=y(e.size,t,a,r)*g,{image:h,width:u,height:d}=this._getPictureResource(e,f,y(e.color,t,a,r));return M={image:h,size:[u,d],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},M}$(o,g,{preserveOutlineWidth:!1}),s=o}c+=n,i&&(c+=JSON.stringify(i));const l=this._resourceCache;return l.has(c)?l.get(c):(M=this._rasterizer.rasterizeJSONResource({cim:s,type:e.type,url:e.url,mosaicHash:c,size:w,path:p},window.devicePixelRatio||1,this._avoidSDF),l.set(c,M),M)}_rasterizeTextResource(e,t,n,i,a){const r=D(n,e,null),o=y(e.text,t,i,a);if(!o||o.length===0)return null;const s=y(e.fontName,t,i,a),c=y(e.style,t,i,a),M=y(e.weight,t,i,a),w=y(e.decoration,t,i,a),p=y(e.size,t,i,a)*r,l=y(e.horizontalAlignment,t,i,a),g=y(e.verticalAlignment,t,i,a),f=U(y(e.color,t,i,a)),h=U(y(e.outlineColor,t,i,a)),u={color:f,size:p,horizontalAlignment:l,verticalAlignment:g,font:{family:s,style:c,weight:M,decoration:w},halo:{size:y(e.outlineSize,t,i,a)||0,color:h,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,u)}_rasterizePictureResource(e,t,n,i,a,r){const o=document.createElement("canvas"),s=o.getContext("2d");o.height=z(Math.max(a.frame.ymax-a.frame.ymin,r)),o.width=z(a.frame.xmax-a.frame.xmin);const c=s.createImageData(n,i);c.data.set(new Uint8ClampedArray(t.buffer));const M=this._imageDataToCanvas(c),w=s.createPattern(M,"repeat"),p=Math.cos((-e.cim.rotation||0)*Math.PI/180),l=Math.sin((-e.cim.rotation||0)*Math.PI/180);w.setTransform({m11:p,m12:l,m21:-l,m22:p,m41:z(e.cim.offsetX)||0,m42:z(e.cim.offsetY)||0});const g=a.canvasPaths;let f,h,u;E(g)?(f=g.rings,s.fillStyle=w,h=s.fill,u=["evenodd"]):ee(g)&&(f=g.paths,s.strokeStyle=w,s.lineWidth=r,h=s.stroke,f[0][0][1]=o.height/2,f[0][1][1]=o.height/2),s.beginPath();for(const I of f){const x=I?I.length:0;if(x>1){let P=I[0];s.moveTo(z(P[0]),z(P[1]));for(let _=1;_<x;++_)P=I[_],s.lineTo(z(P[0]),z(P[1]));s.closePath()}}h.apply(s,u);const d=s.getImageData(0,0,o.width,o.height),C=new Uint8Array(d.data);return{size:[o.width,o.height],image:new Uint32Array(C.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,n){const i=this._pictureMarkerCache.get(e.materialHash);if(!i)return null;const a=i.height/i.width,r=t?a>1?z(t):z(t)/a:i.width,o=t?a>1?z(t)*a:z(t):i.height;return{image:this._imageTo32Array(i,r,o,n),width:r,height:o}}_embedCIMLayerInVectorMarker(e,t){const n=E(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",i=t.frame;return{type:"CIMVectorMarker",frame:i,size:i.ymax-i.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:n,symbolLayers:[e]}}]}}}function fe(m){return(m?Object.keys(m):[]).map(e=>({name:e,alias:e,type:typeof m[e]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}function ge(m){if(!(m&&m.data&&m.data.symbol))return null;switch(m.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function R(m,e,t,n){let i,a;return typeof m.materialHash=="function"?(i=(0,m.materialHash)(e,t,n),a=oe(m.cim,m.materialOverrides)):(i=m.materialHash,a=m.cim),{analyzedCIM:a,hash:i}}const ue=new he(null,!0),ye=te.maxSize;async function Se(m,e={}){const{size:t,maxSize:n,node:i,opacity:a}=e,r=e.cimOptions||e,{feature:o,fieldMap:s,geometryType:c,style:M}=r,w=ae(m),p=typeof t=="number"?t:null,l=Math.min(p!=null?p:w,n!=null?n:ne(ye));l!==w&&(m=m.clone(),ie(m,l,{preserveOutlineWidth:!0}));let g=3;m&&m.data&&m.data.symbol&&m.data.symbol.type!=="CIMPointSymbol"&&(g=1);const f=await ue.rasterizeCIMSymbolAsync(m,o,s,c,{scaleFactor:g,style:M}),h=document.createElement("canvas");h.width=f.imageData.width,h.height=f.imageData.height,h.getContext("2d").putImageData(f.imageData,0,0);let u=h.width/g,d=h.height/g;if(t!=null&&((e==null?void 0:e.scale)==null||(e==null?void 0:e.scale))){const x=u/d;u=x<=1?Math.ceil(l*x):l,d=x<=1?l:Math.ceil(l/x)}const C=new Image(u,d);C.src=h.toDataURL(),a!=null&&(C.style.opacity=`${a}`);let I=C;if(e.effectView!=null){const x={shape:{type:"image",x:0,y:0,width:u,height:d,src:C.src},fill:null,stroke:null,offset:[0,0]};I=re([[x]],[u,d],{effectView:e.effectView})}return i&&i.appendChild(I),I}export{Se as previewCIMSymbol};
